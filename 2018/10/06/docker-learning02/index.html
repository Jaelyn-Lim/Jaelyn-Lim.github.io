<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head>
  
<script type="text/javascript">
    var _speedMark = new Date();
</script>

<script type="text/javascript" src="http://tajs.qq.com/stats?sId=64866827" charset="UTF-8"></script>


<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">



  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />










  <meta name="baidu-site-verification" content="HRlPcTjXKc" />







  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/uploads/apple-touch-icon.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/uploads/favicon-32x32.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/uploads/favicon-16x16.png?v=5.1.3">


  <link rel="mask-icon" href="/images/uploads/safari-pinned-tab.svg?v=5.1.3" color="#222">


  <link rel="manifest" href="/images/uploads/manifest.json">


  <meta name="msapplication-config" content="/images/uploads/browserconfig.xml" />



  <meta name="keywords" content="Docker 学习" />










<meta name="description" content="Docker 网络 网络的基本概念​    基于数据包的通信方式​    网络分层​    路由的概念​    IP地址和路由​    共有IP和私有IP​    网络地址转换NAT​    Ping 和 Telnet​        Ping 验证ip的可达性​        Telnet：验证服务的可用性">
<meta name="keywords" content="Docker 学习">
<meta property="og:type" content="article">
<meta property="og:title" content="Docker 学习 02">
<meta property="og:url" content="http://jaelyn.coding.me/2018/10/06/docker-learning02/index.html">
<meta property="og:site_name" content="Jaelyn&#39;s Blog">
<meta property="og:description" content="Docker 网络 网络的基本概念​    基于数据包的通信方式​    网络分层​    路由的概念​    IP地址和路由​    共有IP和私有IP​    网络地址转换NAT​    Ping 和 Telnet​        Ping 验证ip的可达性​        Telnet：验证服务的可用性">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://jaelyn-blog-txcos-1253450780.cos.ap-guangzhou.myqcloud.com/blog/2018-09-23-Docker%E5%AD%A6%E4%B9%A0.png">
<meta property="og:image" content="https://jaelyn-blog-txcos-1253450780.cos.ap-guangzhou.myqcloud.com/blog/pageimage2018/20180914190159.png">
<meta property="og:image" content="https://jaelyn-blog-txcos-1253450780.cos.ap-guangzhou.myqcloud.com/blog/pageimage2018/20180918163036.png">
<meta property="og:image" content="https://jaelyn-blog-txcos-1253450780.cos.ap-guangzhou.myqcloud.com/blog/2018-09-22-164914.png">
<meta property="og:image" content="https://jaelyn-blog-txcos-1253450780.cos.ap-guangzhou.myqcloud.com/blog/2018-09-24-Docker%E5%AD%A6%E4%B9%A0.png">
<meta property="og:image" content="https://jaelyn-blog-txcos-1253450780.cos.ap-guangzhou.myqcloud.com/blog/2018-10-04-Docker%E5%AD%A6%E4%B9%A0.png">
<meta property="og:image" content="https://jaelyn-blog-txcos-1253450780.cos.ap-guangzhou.myqcloud.com/blog/2018-10-04-033135.png">
<meta property="og:image" content="https://jaelyn-blog-txcos-1253450780.cos.ap-guangzhou.myqcloud.com/blog/2018-10-05-swarmmode.png">
<meta property="og:image" content="https://jaelyn-blog-txcos-1253450780.cos.ap-guangzhou.myqcloud.com/blog/2018-10-04-073137.png">
<meta property="og:image" content="https://jaelyn-blog-txcos-1253450780.cos.ap-guangzhou.myqcloud.com/blog/2018-10-04-091251.png">
<meta property="og:image" content="https://jaelyn-blog-txcos-1253450780.cos.ap-guangzhou.myqcloud.com/blog/2018-10-04-091600.png">
<meta property="og:image" content="https://jaelyn-blog-txcos-1253450780.cos.ap-guangzhou.myqcloud.com/blog/2018-10-04-092554.png">
<meta property="og:image" content="https://jaelyn-blog-txcos-1253450780.cos.ap-guangzhou.myqcloud.com/blog/2018-10-04-092832.png">
<meta property="og:image" content="https://jaelyn-blog-txcos-1253450780.cos.ap-guangzhou.myqcloud.com/blog/2018-10-04-092922.png">
<meta property="og:image" content="https://jaelyn-blog-txcos-1253450780.cos.ap-guangzhou.myqcloud.com/blog/2018-10-04-093018.png">
<meta property="og:image" content="https://jaelyn-blog-txcos-1253450780.cos.ap-guangzhou.myqcloud.com/blog/2018-10-04-095140.png">
<meta property="og:image" content="https://jaelyn-blog-txcos-1253450780.cos.ap-guangzhou.myqcloud.com/blog/2018-10-04-095836.png">
<meta property="og:image" content="https://jaelyn-blog-txcos-1253450780.cos.ap-guangzhou.myqcloud.com/blog/2018-10-04-102909.png">
<meta property="og:image" content="https://jaelyn-blog-txcos-1253450780.cos.ap-guangzhou.myqcloud.com/blog/2018-10-04-102948.png">
<meta property="og:image" content="https://jaelyn-blog-txcos-1253450780.cos.ap-guangzhou.myqcloud.com/blog/2018-10-04-103032.png">
<meta property="og:image" content="https://jaelyn-blog-txcos-1253450780.cos.ap-guangzhou.myqcloud.com/blog/2018-10-04-103257.png">
<meta property="og:image" content="https://jaelyn-blog-txcos-1253450780.cos.ap-guangzhou.myqcloud.com/blog/2018-10-04-103522.png">
<meta property="og:image" content="https://jaelyn-blog-txcos-1253450780.cos.ap-guangzhou.myqcloud.com/blog/2018-10-05-023904.png">
<meta property="og:image" content="https://jaelyn-blog-txcos-1253450780.cos.ap-guangzhou.myqcloud.com/blog/2018-10-05-074405.png">
<meta property="og:image" content="https://jaelyn-blog-txcos-1253450780.cos.ap-guangzhou.myqcloud.com/blog/2018-10-05-074533.png">
<meta property="og:image" content="https://jaelyn-blog-txcos-1253450780.cos.ap-guangzhou.myqcloud.com/blog/2018-10-05-075749.png">
<meta property="og:image" content="https://jaelyn-blog-txcos-1253450780.cos.ap-guangzhou.myqcloud.com/blog/2018-10-05-080752.png">
<meta property="og:image" content="https://jaelyn-blog-txcos-1253450780.cos.ap-guangzhou.myqcloud.com/blog/2018-10-05-080933.png">
<meta property="og:image" content="https://jaelyn-blog-txcos-1253450780.cos.ap-guangzhou.myqcloud.com/blog/2018-10-05-081132.png">
<meta property="og:image" content="https://jaelyn-blog-txcos-1253450780.cos.ap-guangzhou.myqcloud.com/blog/2018-10-05-081710.png">
<meta property="og:image" content="https://jaelyn-blog-txcos-1253450780.cos.ap-guangzhou.myqcloud.com/blog/2018-10-05-082216.png">
<meta property="og:image" content="https://jaelyn-blog-txcos-1253450780.cos.ap-guangzhou.myqcloud.com/blog/2018-10-05-082859.png">
<meta property="og:image" content="https://jaelyn-blog-txcos-1253450780.cos.ap-guangzhou.myqcloud.com/blog/2018-10-05-085321.png">
<meta property="og:image" content="https://jaelyn-blog-txcos-1253450780.cos.ap-guangzhou.myqcloud.com/blog/2018-10-05-085546.png">
<meta property="og:image" content="https://jaelyn-blog-txcos-1253450780.cos.ap-guangzhou.myqcloud.com/blog/2018-10-05-162442.png">
<meta property="og:updated_time" content="2018-10-05T17:30:04.897Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Docker 学习 02">
<meta name="twitter:description" content="Docker 网络 网络的基本概念​    基于数据包的通信方式​    网络分层​    路由的概念​    IP地址和路由​    共有IP和私有IP​    网络地址转换NAT​    Ping 和 Telnet​        Ping 验证ip的可达性​        Telnet：验证服务的可用性">
<meta name="twitter:image" content="https://jaelyn-blog-txcos-1253450780.cos.ap-guangzhou.myqcloud.com/blog/2018-09-23-Docker%E5%AD%A6%E4%B9%A0.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: 'S2RJTOM4KM',
      apiKey: '46aa43b4dc81f6d01e063ef5e5dba1a7',
      indexName: 'blog',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://jaelyn.coding.me/2018/10/06/docker-learning02/"/>





  <title>Docker 学习 02 | Jaelyn's Blog</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Jaelyn's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description">jaelyn-lim</h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://jaelyn.coding.me/2018/10/06/docker-learning02/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jaelyn">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jaelyn's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">Docker 学习 02</h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-10-06T01:27:34+08:00">
                2018-10-06
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">更新于&#58;</span>
              
              <time title="更新于" itemprop="dateModified" datetime="2018-10-06T01:30:04+08:00">
                2018-10-06
              </time>
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Docker/" itemprop="url" rel="index">
                    <span itemprop="name">Docker</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv"><i class="fa fa-file-o"></i> 阅读次数
            <span class="busuanzi-value" id="busuanzi_value_page_pv" ></span>
            </span>
          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  10,745
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  55
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="Docker-网络"><a href="#Docker-网络" class="headerlink" title="Docker 网络"></a>Docker 网络</h1><p><img src="https://jaelyn-blog-txcos-1253450780.cos.ap-guangzhou.myqcloud.com/blog/2018-09-23-Docker%E5%AD%A6%E4%B9%A0.png" alt=""></p>
<p>网络的基本概念<br>​    基于数据包的通信方式<br>​    网络分层<br>​    路由的概念<br>​    IP地址和路由<br>​    共有IP和私有IP<br>​    网络地址转换NAT<br>​    Ping 和 Telnet<br>​        Ping 验证ip的可达性<br>​        Telnet：验证服务的可用性</p>
<a id="more"></a>
<h2 id="网络命名空间"><a href="#网络命名空间" class="headerlink" title="网络命名空间"></a>网络命名空间</h2><p>运行一个简单的无限循环的container用于实验， <code>docker run -d --name test1 busybox /bin/sh -c &quot;while true; do sleep 3600;done&quot;</code> ，再开启一个 test2 启动两个 container ，查看两个容器的网络地址。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">(py2) root@jaelyn:/home/docler_file# docker exec test2 ip a</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue qlen 1</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">66: eth0@if67: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue</span><br><span class="line">    link/ether 02:42:ac:11:00:03 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.17.0.3/16 brd 172.17.255.255 scope global eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">(py2) root@jaelyn:/home/docler_file# docker exec test1 ip a</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue qlen 1</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">64: eth0@if65: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue</span><br><span class="line">    link/ether 02:42:ac:11:00:02 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.17.0.2/16 brd 172.17.255.255 scope global eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">(py2) root@jaelyn:/home/docler_file#</span><br></pre></td></tr></table></figure>
<p>可以发现，这两个容器的网络有自己的一个命名空间，两者不受干扰，且两者可以ping通。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PING 172.17.0.3 (172.17.0.3): 56 data bytes</span><br><span class="line">64 bytes from 172.17.0.3: seq=0 ttl=64 time=0.090 ms</span><br><span class="line">64 bytes from 172.17.0.3: seq=1 ttl=64 time=0.086 ms</span><br><span class="line">64 bytes from 172.17.0.3: seq=2 ttl=64 time=0.096 ms</span><br><span class="line">^C</span><br></pre></td></tr></table></figure>
<ul>
<li>查看本机 <strong>namespace</strong></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ip netns list</span><br></pre></td></tr></table></figure>
<ul>
<li>添加 <strong>namespace</strong></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ip netns add test1</span><br></pre></td></tr></table></figure>
<ul>
<li>删除 <strong>namespace</strong></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ip netns delete test1</span><br></pre></td></tr></table></figure>
<p>可以通过 <code>ip netns exec test1 ip a</code> 命令去查看所创建的 namespace 的ip地址。</p>
<p><code>ip link</code> 查看所有的ip信息。</p>
<p><code>ip netns exec test1 ip link</code> 查看 test1 中的 ip link</p>
<p><code>ip netns exec test1 ip link set dev lo up</code> 是test1中的l0端口 up 起来</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; ip netns exec test1 ip link</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN mode DEFAULT group default qlen 1</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br></pre></td></tr></table></figure>
<p>可以看到是 UNKNOWN ，因为端口是成对出现的。</p>
<p><code>ip link add veth-test1 type veth peer name veth-test2</code> 添加一对端口连接</p>
<p><code>ip link set veth-test2 netns test2</code> 添加进去不同 namespace</p>
<p>最后达到的效果如下：</p>
<p><img src="https://jaelyn-blog-txcos-1253450780.cos.ap-guangzhou.myqcloud.com/blog/pageimage2018/20180914190159.png" alt=""></p>
<p><code>ip netns exec test1 ip addr add 192.168.1.1/24 dev veth-test1</code> 分配ip地址</p>
<p><code>ip netns exec test1 ip link set dev veth-test1 up</code> 开启</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&gt; ip netns exec test1 ip a</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">69: veth-test1@if68: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default qlen 1000</span><br><span class="line">    link/ether 72:03:43:e2:48:79 brd ff:ff:ff:ff:ff:ff link-netnsid 1</span><br><span class="line">    inet 192.168.1.1/24 scope global veth-test1</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::7003:43ff:fee2:4879/64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure>
<p>已经开起来了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ip netns exec test1 ping 192.168.1.2</span><br><span class="line">PING 192.168.1.2 (192.168.1.2) 56(84) bytes of data.</span><br><span class="line">64 bytes from 192.168.1.2: icmp_seq=1 ttl=64 time=0.045 ms</span><br><span class="line">64 bytes from 192.168.1.2: icmp_seq=2 ttl=64 time=0.048 ms</span><br><span class="line">64 bytes from 192.168.1.2: icmp_seq=3 ttl=64 time=0.047 ms</span><br><span class="line">64 bytes from 192.168.1.2: icmp_seq=4 ttl=64 time=0.056 ms</span><br><span class="line">64 bytes from 192.168.1.2: icmp_seq=5 ttl=64 time=0.056 ms</span><br><span class="line">^C</span><br><span class="line">--- 192.168.1.2 ping statistics ---</span><br></pre></td></tr></table></figure>
<p>可以ping通</p>
<p>docker 中也是采用这样的原理，为每个容器提供单独的命名空间。</p>
<h2 id="Bridge0"><a href="#Bridge0" class="headerlink" title="Bridge0"></a>Bridge0</h2><ul>
<li>列举Docker的网络信息</li>
</ul>
<p>docker network ls</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt; docker network ls</span><br><span class="line">NETWORK ID          NAME                DRIVER              SCOPE</span><br><span class="line">48ed41551599        bridge              bridge              local</span><br><span class="line">f4d906ed1610        host                host                local</span><br><span class="line">1241e3113337        none                null                local</span><br></pre></td></tr></table></figure>
<ul>
<li>查看某个网络配置信息</li>
</ul>
<p>docker network inspect 48ed41551599</p>
<p>其中有个 Containers ， 其中有 test1 ，表示这个test1连接到了 bridge 上面。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&quot;Containers&quot;: &#123;</span><br><span class="line">            &quot;efbb927b53d45bfce46e5670cf41bc06d6840daf2084f8a3866b03a49190f3f7&quot;: &#123;</span><br><span class="line">                &quot;Name&quot;: &quot;test1&quot;,</span><br><span class="line">                &quot;EndpointID&quot;: &quot;0702aa0933c5b2fedbff45b8df01230121e6bd77b103c6e255e283bd9e8d368a&quot;,</span><br><span class="line">                &quot;MacAddress&quot;: &quot;02:42:ac:11:00:02&quot;,</span><br><span class="line">                &quot;IPv4Address&quot;: &quot;172.17.0.2/16&quot;,</span><br><span class="line">                &quot;IPv6Address&quot;: &quot;&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br></pre></td></tr></table></figure>
<p>网桥管理工具：<strong>brctl</strong></p>
<blockquote>
<p><strong>网桥</strong>：将两个相似的网络连接起来，并对网络数据的流通进行管理。它工作于数据链路层</p>
<p>不但能扩展网络的距离或范围，而且可提高网络的性能、可靠性和安全性。</p>
<ol>
<li>与中继器相比多了存储转发功能且具备隔离链路层的冲突域的能力。</li>
<li>与路由器相比他是工作在数据链路层的，可以看作更底层的路由器</li>
<li>与交换机相比，交换机可以看作是多端网桥</li>
</ol>
<p>安装： <code>apt-get install bridge-utils</code></p>
</blockquote>
<p>首先查看存在的网桥：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; brctl show</span><br><span class="line">bridge name     bridge id               STP enabled     interfaces</span><br><span class="line">docker0         8000.024220c6b5aa       no              veth3603400</span><br></pre></td></tr></table></figure>
<p>这个时候再创建一个新的 busybox</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&quot;Containers&quot;: &#123;</span><br><span class="line">            &quot;3c6647e77ba2f27f01f01dd21bcf9f63d14bc95040e7d4ee4f7190de9746a09d&quot;: &#123;</span><br><span class="line">                &quot;Name&quot;: &quot;test2&quot;,</span><br><span class="line">                &quot;EndpointID&quot;: &quot;1281597bba8fe13b69546d898f5987f92d5a29641c96c612fdbd432468191ce8&quot;,</span><br><span class="line">                &quot;MacAddress&quot;: &quot;02:42:ac:11:00:03&quot;,</span><br><span class="line">                &quot;IPv4Address&quot;: &quot;172.17.0.3/16&quot;,</span><br><span class="line">                &quot;IPv6Address&quot;: &quot;&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;efbb927b53d45bfce46e5670cf41bc06d6840daf2084f8a3866b03a49190f3f7&quot;: &#123;</span><br><span class="line">                &quot;Name&quot;: &quot;test1&quot;,</span><br><span class="line">                &quot;EndpointID&quot;: &quot;0702aa0933c5b2fedbff45b8df01230121e6bd77b103c6e255e283bd9e8d368a&quot;,</span><br><span class="line">                &quot;MacAddress&quot;: &quot;02:42:ac:11:00:02&quot;,</span><br><span class="line">                &quot;IPv4Address&quot;: &quot;172.17.0.2/16&quot;,</span><br><span class="line">                &quot;IPv6Address&quot;: &quot;&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br></pre></td></tr></table></figure>
<p>这个时候发现有个新的 <strong>test2</strong> 连接到 <strong>docker0</strong> 上。</p>
<p>此时的网桥状态：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">brctl show</span><br><span class="line">bridge name     bridge id               STP enabled     interfaces</span><br><span class="line">docker0         8000.024220c6b5aa       no              veth3603400</span><br><span class="line">                                                        veth810cbf9</span><br></pre></td></tr></table></figure>
<p>会发现 <strong>docker0</strong> 已经多了一个新的接口。</p>
<p><img src="https://jaelyn-blog-txcos-1253450780.cos.ap-guangzhou.myqcloud.com/blog/pageimage2018/20180918163036.png" alt="@Docker网桥"></p>
<p>最终的实现的效果，这两个容器通过 Docker0 就可以通信了，同样，通过 NAT 技术就可以访问外网了。</p>
<p><strong>下面尝试自己创建一个自己的bridge。</strong></p>
<p><code>docker network create -d bridge my-bridge</code></p>
<p>就可以基于 bridge 创建出来一个自己的bridge</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">docker network ls</span><br><span class="line">NETWORK ID          NAME                DRIVER              SCOPE</span><br><span class="line">48ed41551599        bridge              bridge              local</span><br><span class="line">f4d906ed1610        host                host                local</span><br><span class="line">cecdf2b6033e        my-bridge           bridge              local</span><br><span class="line">1241e3113337        none                null                local</span><br></pre></td></tr></table></figure>
<p>也可以通过 brctl 来查看：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">brctl show</span><br><span class="line">bridge name     bridge id               STP enabled     interfaces</span><br><span class="line">br-cecdf2b6033e         8000.024273a400cc       no</span><br><span class="line">docker0         8000.024220c6b5aa       no              veth3603400</span><br><span class="line">                                                        vethb8124ea</span><br></pre></td></tr></table></figure>
<p>多出来一个 <em>br-cecdf2b6033e</em> 就是新建的bridge。</p>
<p>在创建的时候通过 <code>--network</code> 来指定需要连接的bridge。</p>
<p><code>docker run -d --name test3 --network my-bridge busybox /bin/sh -c &quot;while true; do sleep 3600;done&quot;</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">brctl show</span><br><span class="line">bridge name     bridge id               STP enabled     interfaces</span><br><span class="line">br-cecdf2b6033e         8000.024273a400cc       no              veth3471e42</span><br><span class="line">docker0         8000.024220c6b5aa       no              veth3603400</span><br><span class="line">                                                        vethb8124ea</span><br></pre></td></tr></table></figure>
<p>这时候就有接口了，通过 <code>network inspect</code> （my-bridge的id）也可以查看 Containers 获得接口信息，连接了 test3，而且IP地址是 18 了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">docker network inspect cecdf2b6033e</span><br><span class="line">...</span><br><span class="line">        &quot;Containers&quot;: &#123;</span><br><span class="line">            &quot;c7a25d7bbf991f925498ace4962a2084359f434eb8e0744c591db3e7dd194c85&quot;: &#123;</span><br><span class="line">                &quot;Name&quot;: &quot;test3&quot;,</span><br><span class="line">                &quot;EndpointID&quot;: &quot;044d8aa02551c565ba40e12b58847e96e8a3b6e91f8be8f4763ca4d4d8671282&quot;,</span><br><span class="line">                &quot;MacAddress&quot;: &quot;02:42:ac:12:00:02&quot;,</span><br><span class="line">                &quot;IPv4Address&quot;: &quot;172.18.0.2/16&quot;,</span><br><span class="line">                &quot;IPv6Address&quot;: &quot;&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        ...</span><br></pre></td></tr></table></figure>
<p>对于之前建立的docker也可以通过命令连接到新建的bridge上。</p>
<p><code>docker network connect my-bridge test2</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&quot;Containers&quot;: &#123;</span><br><span class="line">            &quot;c7a25d7bbf991f925498ace4962a2084359f434eb8e0744c591db3e7dd194c85&quot;: &#123;</span><br><span class="line">                &quot;Name&quot;: &quot;test3&quot;,</span><br><span class="line">                &quot;EndpointID&quot;: &quot;044d8aa02551c565ba40e12b58847e96e8a3b6e91f8be8f4763ca4d4d8671282&quot;,</span><br><span class="line">                &quot;MacAddress&quot;: &quot;02:42:ac:12:00:02&quot;,</span><br><span class="line">                &quot;IPv4Address&quot;: &quot;172.18.0.2/16&quot;,</span><br><span class="line">                &quot;IPv6Address&quot;: &quot;&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;cb7e57dee46df5311ebec1cc086c561bce1bb531861d309d3d57daa722b1ae13&quot;: &#123;</span><br><span class="line">                &quot;Name&quot;: &quot;test2&quot;,</span><br><span class="line">                &quot;EndpointID&quot;: &quot;c5caaafa912aee589c9f443327652a6ef92595b023f51781dd38562154aec3ea&quot;,</span><br><span class="line">                &quot;MacAddress&quot;: &quot;02:42:ac:12:00:03&quot;,</span><br><span class="line">                &quot;IPv4Address&quot;: &quot;172.18.0.3/16&quot;,</span><br><span class="line">                &quot;IPv6Address&quot;: &quot;&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br></pre></td></tr></table></figure>
<p>此时看看默认的bridge0的信息：</p>
<figure class="highlight plain"><figcaption><span>network inspect 48ed41551599</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&gt; docker network inspect 48ed41551599</span><br><span class="line">        &quot;Containers&quot;: &#123;</span><br><span class="line">            &quot;cb7e57dee46df5311ebec1cc086c561bce1bb531861d309d3d57daa722b1ae13&quot;: &#123;</span><br><span class="line">                &quot;Name&quot;: &quot;test2&quot;,</span><br><span class="line">                &quot;EndpointID&quot;: &quot;4ac2cd292304aecb4bac52e793dd5738f9a279247cdf6bb1fb163ecb0f2699a8&quot;,</span><br><span class="line">                &quot;MacAddress&quot;: &quot;02:42:ac:11:00:03&quot;,</span><br><span class="line">                &quot;IPv4Address&quot;: &quot;172.17.0.3/16&quot;,</span><br><span class="line">                &quot;IPv6Address&quot;: &quot;&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;efbb927b53d45bfce46e5670cf41bc06d6840daf2084f8a3866b03a49190f3f7&quot;: &#123;</span><br><span class="line">                &quot;Name&quot;: &quot;test1&quot;,</span><br><span class="line">                &quot;EndpointID&quot;: &quot;0702aa0933c5b2fedbff45b8df01230121e6bd77b103c6e255e283bd9e8d368a&quot;,</span><br><span class="line">                &quot;MacAddress&quot;: &quot;02:42:ac:11:00:02&quot;,</span><br><span class="line">                &quot;IPv4Address&quot;: &quot;172.17.0.2/16&quot;,</span><br><span class="line">                &quot;IPv6Address&quot;: &quot;&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br></pre></td></tr></table></figure>
<p>发现原来的bridge也有原来test2的信息，也就是docker容器test2连接了两个网桥（bridge0和my-bridge）。</p>
<p>对于18的网路来说可以ping通。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">/ # ping 172.18.0.3</span><br><span class="line">PING 172.18.0.3 (172.18.0.3): 56 data bytes</span><br><span class="line">64 bytes from 172.18.0.3: seq=0 ttl=64 time=0.122 ms</span><br><span class="line">64 bytes from 172.18.0.3: seq=1 ttl=64 time=0.100 ms</span><br><span class="line">^C</span><br><span class="line">--- 172.18.0.3 ping statistics ---</span><br><span class="line">2 packets transmitted, 2 packets received, 0% packet loss</span><br><span class="line">round-trip min/avg/max = 0.100/0.111/0.122 ms</span><br><span class="line">/ # ping 172.18.0.2</span><br><span class="line">PING 172.18.0.2 (172.18.0.2): 56 data bytes</span><br><span class="line">64 bytes from 172.18.0.2: seq=0 ttl=64 time=0.047 ms</span><br><span class="line">64 bytes from 172.18.0.2: seq=1 ttl=64 time=0.049 ms</span><br><span class="line">^C</span><br><span class="line">--- 172.18.0.2 ping statistics ---</span><br><span class="line">2 packets transmitted, 2 packets received, 0% packet loss</span><br><span class="line">round-trip min/avg/max = 0.047/0.048/0.049 ms</span><br></pre></td></tr></table></figure>
<p>不过这里有个例外：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">/ # ping test2</span><br><span class="line">PING test2 (172.18.0.3): 56 data bytes</span><br><span class="line">64 bytes from 172.18.0.3: seq=0 ttl=64 time=0.066 ms</span><br><span class="line">64 bytes from 172.18.0.3: seq=1 ttl=64 time=0.093 ms</span><br><span class="line">64 bytes from 172.18.0.3: seq=2 ttl=64 time=0.090 ms</span><br><span class="line">^C</span><br><span class="line">--- test2 ping statistics ---</span><br><span class="line">3 packets transmitted, 3 packets received, 0% packet loss</span><br><span class="line">round-trip min/avg/max = 0.066/0.083/0.093 ms</span><br></pre></td></tr></table></figure>
<p>进去test2进行测试：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it test2 /bin/sh</span><br><span class="line">/ # ping test3</span><br><span class="line">PING test3 (172.18.0.2): 56 data bytes</span><br><span class="line">64 bytes from 172.18.0.2: seq=0 ttl=64 time=0.068 ms</span><br><span class="line">64 bytes from 172.18.0.2: seq=1 ttl=64 time=0.088 ms</span><br><span class="line">64 bytes from 172.18.0.2: seq=2 ttl=64 time=0.086 ms</span><br><span class="line">^C</span><br><span class="line">--- test3 ping statistics ---</span><br><span class="line">3 packets transmitted, 3 packets received, 0% packet loss</span><br><span class="line">round-trip min/avg/max = 0.068/0.080/0.088 ms</span><br><span class="line">/ # ping test1</span><br><span class="line">ping: bad address &apos;test1&apos;</span><br></pre></td></tr></table></figure>
<p>这个时候，对于自己创建的my-bridge，连接到这个bridge中的内容都能相互通过名字ping通，如果使用默认的bridge0就不行。</p>
<p>接着尝试将test1加到my-bridge中。</p>
<p><code>docker network connect my-bridge test1</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it test2 /bin/sh</span><br><span class="line">/ # ping test1</span><br><span class="line">PING test1 (172.18.0.4): 56 data bytes</span><br><span class="line">64 bytes from 172.18.0.4: seq=0 ttl=64 time=0.090 ms</span><br><span class="line">64 bytes from 172.18.0.4: seq=1 ttl=64 time=0.090 ms</span><br><span class="line">^C</span><br><span class="line">--- test1 ping statistics ---</span><br><span class="line">2 packets transmitted, 2 packets received, 0% packet loss</span><br><span class="line">round-trip min/avg/max = 0.090/0.090/0.090 ms</span><br></pre></td></tr></table></figure>
<p>此时就能用名字ping通了，这个就是自己定义的bridge和系统定义的bridge的区别。</p>
<h2 id="link"><a href="#link" class="headerlink" title="link"></a>link</h2><p>在一个docker容器中使用名称访问另外一个docker容器。</p>
<p><code>docker run -d --name test2 --link test1 busybox /bin/sh -c &quot;while true; do sleep 3600;done&quot;</code></p>
<p>例如，在进行ping操作的时候，我们可以直接使用名称代替ip：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">PING test1 (172.17.0.2): 56 data bytes</span><br><span class="line">64 bytes from 172.17.0.2: seq=0 ttl=64 time=0.086 ms</span><br><span class="line">64 bytes from 172.17.0.2: seq=1 ttl=64 time=0.081 ms</span><br><span class="line">64 bytes from 172.17.0.2: seq=2 ttl=64 time=0.079 ms</span><br><span class="line">64 bytes from 172.17.0.2: seq=3 ttl=64 time=0.082 ms</span><br><span class="line">^C</span><br><span class="line">--- test1 ping statistics ---</span><br><span class="line">4 packets transmitted, 4 packets received, 0% packet loss</span><br><span class="line">round-trip min/avg/max = 0.079/0.082/0.086 ms</span><br></pre></td></tr></table></figure>
<p>其实相当于是添加一个DNS的记录，就可以直接使用名称来使用，并不用去查找实际的IP地址。</p>
<p>再例如，如果要访问test1中的数据库服务的话，就可以直接使用 <strong>test1:3306</strong> 。</p>
<p>不过从test2中就不能通过test1来访问了，link是有方向的。</p>
<blockquote>
<p>实际的使用并不多，就例如自己创建的bridge的话，就可以直接使用名称进行交互。</p>
</blockquote>
<h2 id="端口映射"><a href="#端口映射" class="headerlink" title="端口映射"></a>端口映射</h2><p>我们需要在docker所在的机器外面也能访问这个端口和程序，不应该只是在本机器上访问，所以我们才需要使用端口映射，将docker开放的端口映射到本机器上的端口上。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --name web -p 80:80 nginx</span><br></pre></td></tr></table></figure>
<p>可以使用简单的 <code>-p</code> 来进行设置。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker ps</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND                  CREATED              STATUS              PORTS                NAMES</span><br><span class="line">d788d0a91b09        nginx               &quot;nginx -g &apos;daemon of…&quot;   About a minute ago   Up About a minute   0.0.0.0:80-&gt;80/tcp   web</span><br></pre></td></tr></table></figure>
<p>这样，就可以在本机器上访问127.0.0.1:80就可以访问，就不用必须要172.17.0.2来访问了。</p>
<p>表示将容器的80端口映射到机器的80端口。</p>
<h2 id="Host-和-none"><a href="#Host-和-none" class="headerlink" title="Host 和 none"></a>Host 和 none</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">docker network ls</span><br><span class="line">NETWORK ID          NAME                DRIVER              SCOPE</span><br><span class="line">48ed41551599        bridge              bridge              local</span><br><span class="line">f4d906ed1610        host                host                local</span><br><span class="line">cecdf2b6033e        my-bridge           bridge              local</span><br><span class="line">1241e3113337        none                null                local</span><br></pre></td></tr></table></figure>
<p>首先尝试去创建一个none网络。</p>
<p><code>docker run -d --name test1 --network none busybox /bin/sh -C &quot;while true; do sleep 3600;done&quot;</code></p>
<p>这时候去查看 inspect none ：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&gt; docker network inspect none</span><br><span class="line">        &quot;Containers&quot;: &#123;</span><br><span class="line">            &quot;fc92dc580398244ae73d6005a33871999a2cd8e4d415a46aca2cf1c5c97c2d99&quot;: &#123;</span><br><span class="line">                &quot;Name&quot;: &quot;test1&quot;,</span><br><span class="line">                &quot;EndpointID&quot;: &quot;703c8590b9619a3e747f0f2b7dcd0cb93f92a488fe3a987b47706676496db160&quot;,</span><br><span class="line">                &quot;MacAddress&quot;: &quot;&quot;,</span><br><span class="line">                &quot;IPv4Address&quot;: &quot;&quot;,</span><br><span class="line">                &quot;IPv6Address&quot;: &quot;&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br></pre></td></tr></table></figure>
<p>进去容器里面查看：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it test1 /bin/sh</span><br><span class="line">/ # ip a</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue qlen 1</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure>
<p>也是发现只有一个loop网络就没了，也就是除了容器自己可以访问自己，之外的就不能访问了，可以用于一些安全性较高的容器，保存密码或生成秘钥之类。</p>
<p> 下面指定 network 为 host ：<code>docker run -d --name test --network host busybox /bin/sh -c &quot;while true; do sleep 3600; done&quot;</code></p>
<p>查看 network 信息：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&gt; docker network inspect host</span><br><span class="line">        &quot;Containers&quot;: &#123;</span><br><span class="line">            &quot;bbb0f295d4f4999452c49ca0b0ce3f6cc74e64685653ff275b5e12f6e6f0bb91&quot;: &#123;</span><br><span class="line">                &quot;Name&quot;: &quot;test&quot;,</span><br><span class="line">                &quot;EndpointID&quot;: &quot;38ad3906759c65728a1447416933689a0c3a4afc5a75f40d6985b2eaf83e0bfb&quot;,</span><br><span class="line">                &quot;MacAddress&quot;: &quot;&quot;,</span><br><span class="line">                &quot;IPv4Address&quot;: &quot;&quot;,</span><br><span class="line">                &quot;IPv6Address&quot;: &quot;&quot;</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure>
<p>在外面没有发现有IP地址，进去容器内部查看：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it test /bin/sh</span><br><span class="line">/ # ip a</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue qlen 1</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast qlen 1000</span><br><span class="line">    link/ether 00:16:3e:04:09:8c brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.16.225.238/20 brd 172.16.239.255 scope global eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">3: docker0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue</span><br><span class="line">    link/ether 02:42:20:c6:b5:aa brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">70: veth-test2@veth-test1: &lt;BROADCAST,MULTICAST,M-DOWN&gt; mtu 1500 qdisc noop qlen 1000</span><br><span class="line">    link/ether ca:00:98:c3:7f:5a brd ff:ff:ff:ff:ff:ff</span><br><span class="line">71: veth-test1@veth-test2: &lt;BROADCAST,MULTICAST,M-DOWN&gt; mtu 1500 qdisc noop qlen 1000</span><br><span class="line">    link/ether b6:97:55:fb:b9:40 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">78: br-cecdf2b6033e: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue</span><br><span class="line">    link/ether 02:42:73:a4:00:cc brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.18.0.1/16 brd 172.18.255.255 scope global br-cecdf2b6033e</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure>
<p>会发现和外面主机上的网络是一样的，也就是共享一套主机的网络，使用的时候要注意端口冲突。</p>
<h2 id="多容器复杂应用"><a href="#多容器复杂应用" class="headerlink" title="多容器复杂应用"></a>多容器复杂应用</h2><p><img src="https://jaelyn-blog-txcos-1253450780.cos.ap-guangzhou.myqcloud.com/blog/2018-09-22-164914.png" alt=""></p>
<p>还是基于web服务，先编写app.py文件。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">from</span> redis <span class="keyword">import</span> Redis</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">redis = Redis(host=os.environ.get(<span class="string">'REDIS_HOST'</span>, <span class="string">'127.0.0.1'</span>), port=<span class="number">6379</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello</span><span class="params">()</span>:</span></span><br><span class="line">    redis.incr(<span class="string">'hits'</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'hello Container World! i have been seen %s time and my hostname is %s .\n'</span> % (redis.get(<span class="string">'hits'</span>), socket.gethostname())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    app.run(host=<span class="string">"0.0.0.0"</span>, port=<span class="number">5000</span>, debug=<span class="keyword">True</span>)</span><br></pre></td></tr></table></figure>
<p>在这里面可以看到要用到 redis ，可以单独为redis创建一个容器，来达到跨容器的目的。</p>
<p><code>docker run -d --name myredis redis</code></p>
<p>之所以有没有绑定端口，因为不需要被外面的机器所访问，只需要被flask的web服务所访问就行。</p>
<p>编写 Dockerfile 文件：</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> python:<span class="number">2.7</span></span><br><span class="line"><span class="keyword">label</span><span class="bash"> maintaner=<span class="string">"jaelyn lim"</span></span></span><br><span class="line"><span class="bash">copy . /app</span></span><br><span class="line"><span class="bash">workdir /app</span></span><br><span class="line"><span class="bash">run pip install flask redis</span></span><br><span class="line"><span class="bash">expose 5000</span></span><br><span class="line"><span class="bash">cmd python app.py</span></span><br></pre></td></tr></table></figure>
<p>Build：</p>
<p><code>docker build -t jaelyn/flask-redis .</code></p>
<p>Run：</p>
<p><code>docker run -d --link myredis --name flask-redis -e REDIS_HOST=myredis -p 5000:5000 jaelyn/flask-redis</code></p>
<p>进去容器中看看：</p>
<p><code>docker exec -it flask-redis /bin/sh</code></p>
<p>这里使用命令 <em>env</em> 来查看容器中环境变量。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"># env</span><br><span class="line">MYREDIS_ENV_GOSU_VERSION=1.10</span><br><span class="line">PYTHONIOENCODING=UTF-8</span><br><span class="line">HOSTNAME=2f3a2e877679</span><br><span class="line">PYTHON_PIP_VERSION=18.0</span><br><span class="line">HOME=/root</span><br><span class="line">MYREDIS_PORT=tcp://172.17.0.2:6379</span><br><span class="line">GPG_KEY=C01E1CAD5EA2C4F0B8E3571504C367C218ADD4FF</span><br><span class="line">MYREDIS_PORT_6379_TCP_ADDR=172.17.0.2</span><br><span class="line">MYREDIS_NAME=/flask-redis/myredis</span><br><span class="line">MYREDIS_PORT_6379_TCP_PORT=6379</span><br><span class="line">MYREDIS_PORT_6379_TCP_PROTO=tcp</span><br><span class="line">MYREDIS_ENV_REDIS_DOWNLOAD_URL=http://download.redis.io/releases/redis-4.0.11.tar.gz</span><br><span class="line">TERM=xterm</span><br><span class="line">MYREDIS_ENV_REDIS_VERSION=4.0.11</span><br><span class="line">PATH=/usr/local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin</span><br><span class="line">MYREDIS_PORT_6379_TCP=tcp://172.17.0.2:6379</span><br><span class="line">LANG=C.UTF-8</span><br><span class="line">PYTHON_VERSION=2.7.15</span><br><span class="line">MYREDIS_ENV_REDIS_DOWNLOAD_SHA=fc53e73ae7586bcdacb4b63875d1ff04f68c5474c1ddeda78f00e5ae2eed1bbb</span><br><span class="line">REDIS_HOST=myredis</span><br><span class="line">PWD=/app</span><br></pre></td></tr></table></figure>
<p>这里可以看到，里面有REDIS_HOST的环境变量，尝试使用ping：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># ping myredis</span><br><span class="line">PING myredis (172.17.0.2) 56(84) bytes of data.</span><br><span class="line">64 bytes from myredis (172.17.0.2): icmp_seq=1 ttl=64 time=0.106 ms</span><br><span class="line">64 bytes from myredis (172.17.0.2): icmp_seq=2 ttl=64 time=0.079 ms</span><br><span class="line">64 bytes from myredis (172.17.0.2): icmp_seq=3 ttl=64 time=0.074 ms</span><br><span class="line">^C</span><br><span class="line">--- myredis ping statistics ---</span><br><span class="line">3 packets transmitted, 3 received, 0% packet loss, time 1999ms</span><br><span class="line">rtt min/avg/max/mdev = 0.074/0.086/0.106/0.016 ms</span><br></pre></td></tr></table></figure>
<p>可以直接访问，也可以访问网址：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; curl 127.0.0.1:5000</span><br><span class="line">hello Container World! i have been seen 1 time and my hostname is 4dbb8131a408 .</span><br></pre></td></tr></table></figure>
<p>这里说明一下命令中使用 <code>-p</code> 和在 Dockerfile 中使用 expose 的区别：</p>
<ul>
<li>使用 <code>-p</code> 是将端口和本机器的端口进行一个“绑定”，使得端口能直接访问容器中的端口。</li>
<li>expose 的方式只是将容器的端口暴露出来，允许别的机器（容器）能访问。</li>
</ul>
<blockquote>
<p><code>-e</code> 表示设置环境变量，对于一些使用配置启动的容器很有帮助。</p>
</blockquote>
<p>如果需要在堕胎机器上的容器进行通信的话，采用的是 vxlan 的方式。</p>
<p>参考：</p>
<p><a href="https://www.evoila.de/de/blog/2015/11/06/what-is-vxlan-and-how-it-works/" target="_blank" rel="noopener">https://www.evoila.de/de/blog/2015/11/06/what-is-vxlan-and-how-it-works/</a></p>
<h1 id="Docker-持久化存储和数据共享"><a href="#Docker-持久化存储和数据共享" class="headerlink" title="Docker 持久化存储和数据共享"></a>Docker 持久化存储和数据共享</h1><p><img src="https://jaelyn-blog-txcos-1253450780.cos.ap-guangzhou.myqcloud.com/blog/2018-09-24-Docker%E5%AD%A6%E4%B9%A0.png" alt=""></p>
<p>volume 的类型：</p>
<ul>
<li>受管理的data volume， 由docker后台创建</li>
<li>绑定挂载的volume，具体挂载位置可以指定</li>
</ul>
<h2 id="Data-Volume"><a href="#Data-Volume" class="headerlink" title="Data Volume"></a>Data Volume</h2><p>用mysql数据库来进行测试。</p>
<p><code>docker run -d --name mysql1 -e MYSQL_ALLOW_EMPTY_PASSWORD=true mysql</code></p>
<blockquote>
<p> MYSQL_ALLOW_EMPTY_PASSWORD 表示允许无密码访问</p>
</blockquote>
<p>通过 <code>docker volume ls</code> 来查看所有的volume</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker volume ls</span><br><span class="line">DRIVER              VOLUME NAME</span><br><span class="line">local               3242d2186713d076226f8335fb8996705aefcae7670869319f5acd6ae53d77c5</span><br></pre></td></tr></table></figure>
<p>使用 <code>docker volume inspect</code> 来查看详细信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&gt; docker volume inspect 3242d2186713d076226f8335fb8996705aefcae7670869319f5acd6ae53d77c5</span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;CreatedAt&quot;: &quot;2018-09-24T10:37:03+08:00&quot;,</span><br><span class="line">        &quot;Driver&quot;: &quot;local&quot;,</span><br><span class="line">        &quot;Labels&quot;: null,</span><br><span class="line">        &quot;Mountpoint&quot;: &quot;/var/lib/docker/volumes/3242d2186713d076226f8335fb8996705aefcae7670869319f5acd6ae53d77c5/_data&quot;,</span><br><span class="line">        &quot;Name&quot;: &quot;3242d2186713d076226f8335fb8996705aefcae7670869319f5acd6ae53d77c5&quot;,</span><br><span class="line">        &quot;Options&quot;: null,</span><br><span class="line">        &quot;Scope&quot;: &quot;local&quot;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>可以发现，这个volume是保存在机器本身的，并且将container删除之后，volume也不会被删除，这也保证了数据的持有，不过发现这个volume的名称太长。</p>
<p>可以通过 <code>-v</code> 的参数指定</p>
<p><code>docker run -d -v mysql:/var/lib/mysql --name mysql2 -e MYSQL_ALLOW_EMPTY_PASSWORD=true mysql</code></p>
<p>这个时候，就有简单的volume名称：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; docker volume ls</span><br><span class="line">DRIVER              VOLUME NAME</span><br><span class="line">local               mysql</span><br></pre></td></tr></table></figure>
<p>inspect：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&gt; docker volume ls</span><br><span class="line">DRIVER              VOLUME NAME</span><br><span class="line">local               mysql</span><br><span class="line">(py3) root@jaelyn:/home/docler_file/flask-redis# docker volume inspect mysql</span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;CreatedAt&quot;: &quot;2018-09-24T11:56:35+08:00&quot;,</span><br><span class="line">        &quot;Driver&quot;: &quot;local&quot;,</span><br><span class="line">        &quot;Labels&quot;: null,</span><br><span class="line">        &quot;Mountpoint&quot;: &quot;/var/lib/docker/volumes/mysql/_data&quot;,</span><br><span class="line">        &quot;Name&quot;: &quot;mysql&quot;,</span><br><span class="line">        &quot;Options&quot;: null,</span><br><span class="line">        &quot;Scope&quot;: &quot;local&quot;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>验证一下（在容器下创建一个database，并且将容器删除之后查看volume是否存在）：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"> &gt; docker exec -it mysql2 /bin/sh</span><br><span class="line"> # mysql -uroot -p</span><br><span class="line">Enter password:</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 8</span><br><span class="line">Server version: 8.0.12 MySQL Community Server - GPL</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2018, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt;</span><br><span class="line">mysql&gt; show databases;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| sys                |</span><br><span class="line">+--------------------+</span><br><span class="line">4 rows in set (0.01 sec)</span><br><span class="line">mysql&gt; create database docker;</span><br><span class="line">Query OK, 1 row affected (0.05 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; show databases;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| docker             |</span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| sys                |</span><br><span class="line">+--------------------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt;</span><br></pre></td></tr></table></figure>
<p>删除之后，创建一个新的container并且 <code>-v</code> 参数还是选择原来的volume</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">&gt; docker stop mysql2</span><br><span class="line">mysql2</span><br><span class="line">&gt; docker rm mysql2</span><br><span class="line">mysql2</span><br><span class="line">&gt; docker ps -a</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES</span><br><span class="line">&gt; docker volume ls</span><br><span class="line">DRIVER              VOLUME NAME</span><br><span class="line">local               mysql</span><br><span class="line">&gt; docker run -d -v mysql:/var/lib/mysql --name mysql2 -e MYSQL_ALLOW_EMPTY_PASSWORD=true mysql</span><br><span class="line">b7df8af4567ba2d45fa0a985d69d4264d8f77aae955c3ed4a722e6b6a92d40ce</span><br><span class="line">&gt; docker exec -it mysql2 /bin/sh</span><br><span class="line"># mysql -uroot -p</span><br><span class="line">Enter password:</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 8</span><br><span class="line">Server version: 8.0.12 MySQL Community Server - GPL</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2018, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt; show databases;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| docker             |</span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| sys                |</span><br><span class="line">+--------------------+</span><br><span class="line">5 rows in set (0.01 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt;</span><br></pre></td></tr></table></figure>
<p>可以发现，volume还在并且依旧有之前创建的 <code>database</code></p>
<blockquote>
<p>也可以在 Dockerfile 文件中定义 <code>volume [&quot;/var/lib/mysql&quot;]</code> 的方式创建 volume，如果在命令中使用 -v 的话，就可以重新命名，并且指定一个新的容器中的地址来存储。</p>
</blockquote>
<h2 id="Bild-Mouting"><a href="#Bild-Mouting" class="headerlink" title="Bild Mouting"></a>Bild Mouting</h2><blockquote>
<p>使得本地的文件和容器中的文件同步，一个修改，另外一个也会跟着变动。</p>
</blockquote>
<p>编写 Dockerfile：</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> nginx:latest</span><br><span class="line"><span class="keyword">workdir</span><span class="bash"> /usr/share/nginx/html</span></span><br><span class="line"><span class="bash">copy index.html index.html</span></span><br></pre></td></tr></table></figure>
<p>build：</p>
<p><code>docker build -t lim/docker-nginx .</code></p>
<p>运行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; docker run -d -v $(pwd):/usr/share/nginx/html -p 80:80 --name web lim/docker-nginx</span><br><span class="line">95b1a76b84e2803942783ceafc0eb238d5f8c6cd165dcd66ab70ca1d6994ce5a</span><br></pre></td></tr></table></figure>
<p>这里表示将本地址的目录（ <code>$(pwd)</code> ）映射到容器中的 <code>/usr/share/nginx/html</code> 地址中，可以进去容器中查看：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; docker exec -it web /bin/sh</span><br><span class="line">#</span><br><span class="line"># cd /usr/share/nginx/html</span><br><span class="line"># ls</span><br><span class="line">Dockerfile  index.html</span><br><span class="line">#</span><br></pre></td></tr></table></figure>
<p>之后尝试去创建一个文件： <code># touch test.txt</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; ls</span><br><span class="line">Dockerfile  index.html  test.txt</span><br></pre></td></tr></table></figure>
<p>发现原来的文件下面也有，也就只这两个目录用的是同样的。</p>
<h1 id="Docker-Compose"><a href="#Docker-Compose" class="headerlink" title="Docker Compose"></a>Docker Compose</h1><p><img src="https://jaelyn-blog-txcos-1253450780.cos.ap-guangzhou.myqcloud.com/blog/2018-10-04-Docker%E5%AD%A6%E4%B9%A0.png" alt=""></p>
<h2 id="尝试去创建-wordpress-来使用"><a href="#尝试去创建-wordpress-来使用" class="headerlink" title="尝试去创建 wordpress 来使用"></a>尝试去创建 wordpress 来使用</h2><p>获取 wordpress ：</p>
<p><code>docker pull wordpress</code></p>
<p>运行：</p>
<ul>
<li>运行数据库 mysql ：</li>
</ul>
<p><code>docker run -d --name mysql -v mysql-data:/var/lib/mysql -e MYSQL_ROOT_PASSWORD=root -e MYSQL_DATABASE=wordpress mysql</code></p>
<ul>
<li>运行 Wordpress ：</li>
</ul>
<p><code>docker run -d -e WORDPRESS_DB_HOST=mysql:3306 --link mysql -p 8080:80 wordpress</code></p>
<p>这个时候，通过 8080 端口就可以访问了。</p>
<blockquote>
<p> 这个时候发现，要运行 Wordpress 的时候，同时需要启动 mysql ，也就是说在启动一个服务的时候，同时需要开启多个 container ，这个时候就需要一个工具来统一管理，就出现了 Docker Compose 。</p>
</blockquote>
<h2 id="docker-compose-是什么"><a href="#docker-compose-是什么" class="headerlink" title="docker compose 是什么"></a>docker compose 是什么</h2><h3 id="多容器部署app"><a href="#多容器部署app" class="headerlink" title="多容器部署app"></a>多容器部署app</h3><ul>
<li>要从 Dockerfile build image 或 Dockerhub 拉取 image</li>
<li>要创建多个 container</li>
<li>要管理这些container（启动停止删除）</li>
</ul>
<p>所以 docker compose 就充当了一个批处理的功能。</p>
<h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><ul>
<li>docker compose 是一个工具</li>
<li>可以通过一个 yml 文件定义多个容器的 docker 应用</li>
<li>通过一条命令就可以根据 yml 文件的定义去创建或管理这多个容器</li>
</ul>
<h3 id="默认的名称"><a href="#默认的名称" class="headerlink" title="默认的名称"></a>默认的名称</h3><p>docker-compose.yml</p>
<h3 id="三个概念"><a href="#三个概念" class="headerlink" title="三个概念"></a>三个概念</h3><ul>
<li>Services</li>
<li>Networks</li>
<li>Volumes</li>
</ul>
<h4 id="Services"><a href="#Services" class="headerlink" title="Services"></a>Services</h4><p>一个service代表一个container，这个container可以从dockerhub的image来创建，或者从本地的 Dockerfile build出来的image来创建。</p>
<p>service 的启动类似于docker run，我们可以给其指定network和volume，所以可以给service指定network和volume的引用。</p>
<h3 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">version: &apos;3&apos;</span><br><span class="line"></span><br><span class="line">services:</span><br><span class="line"></span><br><span class="line">  wordpress:</span><br><span class="line">    image: wordpress</span><br><span class="line">    ports:</span><br><span class="line">      - 8080:80</span><br><span class="line">    environment:</span><br><span class="line">      WORDPRESS_DB_HOST: mysql</span><br><span class="line">      WORDPRESS_DB_PASSWORD: root</span><br><span class="line">    networks:</span><br><span class="line">      - my-bridge</span><br><span class="line"></span><br><span class="line">  mysql:</span><br><span class="line">    image: mysql</span><br><span class="line">    environment:</span><br><span class="line">      MYSQL_ROOT_PASSWORD: root</span><br><span class="line">      MYSQL_DATABASE: wordpress</span><br><span class="line">    volumes:</span><br><span class="line">      - mysql-data:/var/lib/mysql</span><br><span class="line">    networks:</span><br><span class="line">      - my-bridge</span><br><span class="line"></span><br><span class="line">volumes:</span><br><span class="line">  mysql-data:</span><br><span class="line"></span><br><span class="line">networks:</span><br><span class="line">  my-bridge:</span><br><span class="line">    driver: bridge</span><br></pre></td></tr></table></figure>
<h2 id="docker-compose-安装和基本使用"><a href="#docker-compose-安装和基本使用" class="headerlink" title="docker-compose 安装和基本使用"></a>docker-compose 安装和基本使用</h2><h3 id="安装下载-docker-compose"><a href="#安装下载-docker-compose" class="headerlink" title="安装下载 docker-compose"></a>安装下载 docker-compose</h3><p>对于 Mac和win 系统来说，docker-compose 是默认安装的，当时对于 Linux 系统来说需要自行安装。</p>
<ul>
<li><a href="https://docs.docker.com/v17.09/compose/install/#install-compose" target="_blank" rel="noopener">官方介绍安装</a></li>
</ul>
<p>首先下载：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo curl -L https://github.com/docker/compose/releases/download/1.18.0/docker-compose-`uname -s`-`uname -m` -o /usr/local/bin/docker-compose</span><br></pre></td></tr></table></figure>
<p>给可执行权限：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo chmod +x /usr/local/bin/docker-compose</span><br></pre></td></tr></table></figure>
<p>这个时候就可以使用了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker-compose --version</span><br><span class="line">docker-compose version 1.18.0, build 8dd22a9</span><br></pre></td></tr></table></figure>
<h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><ul>
<li>docker-compose up</li>
</ul>
<p>用于开启一个docker-compose ， 可以使用 <code>-f</code> 的指令去指明一个文件。</p>
<p>可以通过一个 <code>-d</code> 的指令去指明后台执行，如果 yml 文件的命名采用原始默认的名称（docker-compose.yml）的话，也可以不指定文件名称来运行。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker-compose -f docker-compose.yml up -d</span><br><span class="line"># 常用开启方式</span><br><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure>
<blockquote>
<p>如果需要查看输出的日志，或者在 debug 的时候，可以不加上 <code>-d</code> ，这样就会把所有的日志输出到屏幕上，方便查看。</p>
</blockquote>
<ul>
<li>docker-compose ps</li>
</ul>
<p>用于查看开启的docker-compose 的状态</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker-compose ps</span><br><span class="line">           Name                         Command               State    Ports</span><br><span class="line">----------------------------------------------------------------------------</span><br><span class="line">dockercomposes_mysql_1       docker-entrypoint.sh mysqld      Exit 0        </span><br><span class="line">dockercomposes_wordpress_1   docker-entrypoint.sh apach ...   Exit 0</span><br></pre></td></tr></table></figure>
<ul>
<li>docker-compose stop</li>
</ul>
<p>停止docker-compose</p>
<ul>
<li>docker-compose start</li>
</ul>
<p>开启docker-compose</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker-compose start</span><br><span class="line">Starting wordpress ... done</span><br><span class="line">Starting mysql     ... done</span><br></pre></td></tr></table></figure>
<ul>
<li>docker-compose down</li>
</ul>
<p>删除并且移除docker-compose</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">docker-compose down</span><br><span class="line">Stopping dockercomposes_mysql_1     ... done</span><br><span class="line">Stopping dockercomposes_wordpress_1 ... done</span><br><span class="line">Removing dockercomposes_mysql_1     ... done</span><br><span class="line">Removing dockercomposes_wordpress_1 ... done</span><br><span class="line">Removing network dockercomposes_my-bridge</span><br></pre></td></tr></table></figure>
<ul>
<li>docker-compose images</li>
</ul>
<p>显示docker-compose 所定义的images</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker-compose images</span><br><span class="line">        Container            Repository    Tag       Image Id      Size</span><br><span class="line">------------------------------------------------------------------------</span><br><span class="line">dockercomposes_mysql_1       mysql        latest   6a834f03bd02   462 MB</span><br><span class="line">dockercomposes_wordpress_1   wordpress    latest   ca0fefec932b   390 MB</span><br></pre></td></tr></table></figure>
<ul>
<li>docker-compose exec mysql bash</li>
</ul>
<p>对 docker-compose.yml 文件定义的内容进行交互化运行（进到里面去）。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&gt; docker-compose exec mysql bash</span><br><span class="line">root@2056be6bb10e:/#     </span><br><span class="line">root@2056be6bb10e:/# exit</span><br><span class="line">exit</span><br><span class="line">&gt; docker-compose exec workpress bash</span><br><span class="line">ERROR: No such service: workpress</span><br><span class="line">&gt; docker-compose exec wordpress bash</span><br><span class="line">root@fd68b24dbe20:/var/www/html#</span><br><span class="line">root@fd68b24dbe20:/var/www/html# exit</span><br><span class="line">exit</span><br></pre></td></tr></table></figure>
<h3 id="对于一些需要build的docker-compose"><a href="#对于一些需要build的docker-compose" class="headerlink" title="对于一些需要build的docker-compose"></a>对于一些需要build的docker-compose</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">version: &quot;3&quot;</span><br><span class="line">services:</span><br><span class="line">    redis:</span><br><span class="line">        image: redis</span><br><span class="line">    web:</span><br><span class="line">        build:</span><br><span class="line">            context: .</span><br><span class="line">            dockerfile: Dockerfile</span><br><span class="line">        ports:</span><br><span class="line">            - 8080:5000</span><br><span class="line">        environment:</span><br><span class="line">            REDIS_HOST: redis</span><br></pre></td></tr></table></figure>
<p>context 指明路径</p>
<p>dockerfile 指明文件名称</p>
<p>之后启动 <code>docker-compose up</code></p>
<h2 id="水平扩展扩展和负载均衡"><a href="#水平扩展扩展和负载均衡" class="headerlink" title="水平扩展扩展和负载均衡"></a>水平扩展扩展和负载均衡</h2><p>创建 docker-compose.yml 文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">version: &quot;3&quot;</span><br><span class="line">services:</span><br><span class="line">    redis:</span><br><span class="line">        image: redis</span><br><span class="line">    web:</span><br><span class="line">        build:</span><br><span class="line">            context: .</span><br><span class="line">            dockerfile: Dockerfile</span><br><span class="line">        environment:</span><br><span class="line">            REDIS_HOST: redis</span><br></pre></td></tr></table></figure>
<p>使用 scale 指令去同时开启多个 web</p>
<p><code>docker-compose up --scale web=3 -d</code></p>
<blockquote>
<p>官方的解释： –scale SERVICE=NUM        Scale SERVICE to NUM instances. Overrides the <code>scale</code> setting in the Compose file if present.</p>
</blockquote>
<p>通过 <code>docker-compose ps</code> 查看容器运行状态：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">docker-compose ps</span><br><span class="line">       Name                     Command               State                    Ports                 </span><br><span class="line">-----------------------------------------------------------------------------------------------------</span><br><span class="line">flaskredis_lb_1      /sbin/tini -- dockercloud- ...   Up      1936/tcp, 443/tcp, 0.0.0.0:8080-&gt;80/tcp</span><br><span class="line">flaskredis_redis_1   docker-entrypoint.sh redis ...   Up      6379/tcp                               </span><br><span class="line">flaskredis_web_1     /bin/sh -c python app.py         Up      5000/tcp                               </span><br><span class="line">flaskredis_web_2     /bin/sh -c python app.py         Up      5000/tcp                               </span><br><span class="line">flaskredis_web_3     /bin/sh -c python app.py         Up      5000/tcp</span><br></pre></td></tr></table></figure>
<p>可以看到，开启了三个web中容器，并且监听容器内的5000端口。</p>
<p>这个使用就可以使用这个方法搭建一个负载均衡，使用多个web服务反问一个redis。</p>
<p><img src="https://jaelyn-blog-txcos-1253450780.cos.ap-guangzhou.myqcloud.com/blog/2018-10-04-033135.png" alt=""></p>
<p>前面又个负载均衡，分发多个web服务器上，最后反问一个redis。</p>
<p>接下来将负载均衡加上：</p>
<p>修改 app.py 文件</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">from</span> redis <span class="keyword">import</span> Redis</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">redis = Redis(host=os.environ.get(<span class="string">'REDIS_HOST'</span>, <span class="string">'127.0.0.1'</span>), port=<span class="number">6379</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello</span><span class="params">()</span>:</span></span><br><span class="line">    redis.incr(<span class="string">'hits'</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'hello Container World! i have been seen %s time and my hostname is %s .\n'</span> % (redis.get(<span class="string">'hits'</span>), socket.gethostname())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    app.run(host=<span class="string">"0.0.0.0"</span>, port=<span class="number">80</span>, debug=<span class="keyword">True</span>)</span><br></pre></td></tr></table></figure>
<p>将监听的端口改为 80</p>
<p>修改 Dockerfile</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> python:<span class="number">2.7</span></span><br><span class="line"><span class="keyword">label</span><span class="bash"> maintaner=<span class="string">"jaelyn lim"</span></span></span><br><span class="line"><span class="bash">copy . /app</span></span><br><span class="line"><span class="bash">workdir /app</span></span><br><span class="line"><span class="bash">run pip install flask redis</span></span><br><span class="line"><span class="bash">expose 80</span></span><br><span class="line"><span class="bash">cmd python app.py</span></span><br></pre></td></tr></table></figure>
<p>将暴露的端口也改为 80</p>
<p>修改 docker-compose.yml 文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">version: &quot;3&quot;</span><br><span class="line">services:</span><br><span class="line">    redis:</span><br><span class="line">        image: redis</span><br><span class="line">    web:</span><br><span class="line">        build:</span><br><span class="line">            context: .</span><br><span class="line">            dockerfile: Dockerfile</span><br><span class="line">        environment:</span><br><span class="line">            REDIS_HOST: redis</span><br><span class="line"></span><br><span class="line">    lb:</span><br><span class="line">        image: dockercloud/haproxy</span><br><span class="line">        links:</span><br><span class="line">            - web</span><br><span class="line">        ports:</span><br><span class="line">            - 8080:80</span><br><span class="line">        volumes:</span><br><span class="line">            - /var/run/docker.sock:/var/run/docker.sock</span><br></pre></td></tr></table></figure>
<p>加上了个负载均衡的容器 haproxy</p>
<p>运行，先启动一个web服务 <code>docker-compose up -d</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&gt; docker-compose up -d</span><br><span class="line">Creating flaskredis_web_1   ... done</span><br><span class="line">Creating flaskredis_redis_1 ... done</span><br><span class="line">Creating flaskredis_web_1   ...</span><br><span class="line">Creating flaskredis_lb_1    ... done</span><br><span class="line">&gt; docker-compose ps</span><br><span class="line">       Name                     Command               State                    Ports                 </span><br><span class="line">-----------------------------------------------------------------------------------------------------</span><br><span class="line">flaskredis_lb_1      /sbin/tini -- dockercloud- ...   Up      1936/tcp, 443/tcp, 0.0.0.0:8080-&gt;80/tcp</span><br><span class="line">flaskredis_redis_1   docker-entrypoint.sh redis ...   Up      6379/tcp                               </span><br><span class="line">flaskredis_web_1     /bin/sh -c python app.py         Up      5000/tcp  </span><br><span class="line">&gt; curl 127.0.0.1:8080</span><br><span class="line">hello Container World! i have been seen 1 time and my hostname is c39e2c06e4ab .</span><br></pre></td></tr></table></figure>
<p>开启 3 个 <code>docker-compose up --scale web=3 -d</code></p>
<p>这个时候再次尝试去访问网址：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&gt; curl 127.0.0.1:8080</span><br><span class="line">hello Container World! i have been seen 2 time and my hostname is c39e2c06e4ab .</span><br><span class="line">&gt; curl 127.0.0.1:8080</span><br><span class="line">hello Container World! i have been seen 3 time and my hostname is 32984908b36b .</span><br><span class="line">&gt; curl 127.0.0.1:8080</span><br><span class="line">hello Container World! i have been seen 4 time and my hostname is b9d86e13488b .</span><br><span class="line">&gt; curl 127.0.0.1:8080</span><br><span class="line">hello Container World! i have been seen 5 time and my hostname is c39e2c06e4ab .</span><br><span class="line">&gt; curl 127.0.0.1:8080</span><br><span class="line">hello Container World! i have been seen 6 time and my hostname is 32984908b36b .</span><br></pre></td></tr></table></figure>
<p>就可以发现，地址在是循环变换的，这样就验证了这是一个负载均衡的容器。</p>
<h1 id="Swarm-mode"><a href="#Swarm-mode" class="headerlink" title="Swarm mode"></a>Swarm mode</h1><p><img src="https://jaelyn-blog-txcos-1253450780.cos.ap-guangzhou.myqcloud.com/blog/2018-10-05-swarmmode.png" alt=""></p>
<p>要达到下面这种效果</p>
<p><img src="https://jaelyn-blog-txcos-1253450780.cos.ap-guangzhou.myqcloud.com/blog/2018-10-04-073137.png" alt=""></p>
<p>用于集群</p>
<h2 id="搭建三个节点的-swarm-集群"><a href="#搭建三个节点的-swarm-集群" class="headerlink" title="搭建三个节点的 swarm 集群"></a>搭建三个节点的 swarm 集群</h2><p>首先使用 <code>docker swarm init</code> 命令指定创建一个 docker 的 manager ：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">docker swarm init --advertise-addr=172.16.225.238</span><br><span class="line">Swarm initialized: current node (hzh67fduhfolbi1jqp6u8p1qj) is now a manager.</span><br><span class="line"></span><br><span class="line">To add a worker to this swarm, run the following command:</span><br><span class="line"></span><br><span class="line">    docker swarm join --token SWMTKN-1-0ul1wqlihq61ohbnm3nqyc87pzjpb9lcqfoducnu7pfhlkntb7-9hai3z91reauevc9kijy9gsiw 172.16.225.238:2377</span><br><span class="line"></span><br><span class="line">To add a manager to this swarm, run &apos;docker swarm join-token manager&apos; and follow the instructions.</span><br></pre></td></tr></table></figure>
<p>之后根据提示，使用提示中的 join 命令去添加 worker</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker swarm join --token SWMTKN-1-0ul1wqlihq61ohbnm3nqyc87pzjpb9lcqfoducnu7pfhlkntb7-9hai3z91reauevc9kijy9gsiw 172.16.225.238:2377</span><br></pre></td></tr></table></figure>
<p><img src="https://jaelyn-blog-txcos-1253450780.cos.ap-guangzhou.myqcloud.com/blog/2018-10-04-091251.png" alt=""></p>
<p>添加需要的worker之后，可以使用 <code>docker node ls</code> 命令去查看节点。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; docker node ls</span><br><span class="line">ID                            HOSTNAME            STATUS              AVAILABILITY        MANAGER STATUS      ENGINE VERSION</span><br><span class="line">hzh67fduhfolbi1jqp6u8p1qj *   jaelyn              Ready               Active              Leader              18.03.1-ce</span><br></pre></td></tr></table></figure>
<p><img src="https://jaelyn-blog-txcos-1253450780.cos.ap-guangzhou.myqcloud.com/blog/2018-10-04-091600.png" alt=""></p>
<p>同样的，可以使用 docker playground 来实现：</p>
<p><a href="https://training.play-with-docker.com" target="_blank" rel="noopener">https://training.play-with-docker.com</a></p>
<ul>
<li>登录账号，开始</li>
</ul>
<p><img src="https://jaelyn-blog-txcos-1253450780.cos.ap-guangzhou.myqcloud.com/blog/2018-10-04-092554.png" alt=""></p>
<p>有 4 个小时的倒计时，时间一到就会销毁，用于测试十分方便。</p>
<ul>
<li>创建 swarm</li>
</ul>
<p><img src="https://jaelyn-blog-txcos-1253450780.cos.ap-guangzhou.myqcloud.com/blog/2018-10-04-092832.png" alt=""></p>
<ul>
<li>加入 worker</li>
</ul>
<p><img src="https://jaelyn-blog-txcos-1253450780.cos.ap-guangzhou.myqcloud.com/blog/2018-10-04-092922.png" alt=""></p>
<ul>
<li>查看节点</li>
</ul>
<p><img src="https://jaelyn-blog-txcos-1253450780.cos.ap-guangzhou.myqcloud.com/blog/2018-10-04-093018.png" alt=""></p>
<blockquote>
<p>实验网址：<a href="https://labs.play-with-docker.com" target="_blank" rel="noopener">https://labs.play-with-docker.com</a></p>
</blockquote>
<h2 id="Service-的创建维护和水平扩展"><a href="#Service-的创建维护和水平扩展" class="headerlink" title="Service 的创建维护和水平扩展"></a>Service 的创建维护和水平扩展</h2><p>总的来说 service 和 run 很像，主要还是创建运行容器，不过有区别的就是，run 是当前创建容器，而 service 创建的容器不一定会在本地。在 swarm 模式下面要使用 service 。</p>
<p>依旧创建无限循环的busy box来测试：</p>
<ul>
<li>docker service create</li>
</ul>
<p>创建service</p>
<p><code>docker service create --name demo busybox sh -c &quot;while true;do sleep 2600;done&quot;</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt; docker service create --name demo busybox sh -c &quot;while true;do sleep 2600;done&quot;</span><br><span class="line">bwsnflmg5hddgmmxstfllyxwk</span><br><span class="line">overall progress: 1 out of 1 tasks</span><br><span class="line">1/1: running   [==================================================&gt;]</span><br><span class="line">verify: Service converged</span><br></pre></td></tr></table></figure>
<ul>
<li>docker service ls</li>
</ul>
<p>查看运行中的service</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker service ls</span><br><span class="line">ID                  NAME                MODE                REPLICAS            IMAGE               PORTS</span><br><span class="line">bwsnflmg5hdd        demo                replicated          1/1                 busybox:latest</span><br></pre></td></tr></table></figure>
<ul>
<li>docker service ps demo</li>
</ul>
<p>查看更加详细的情况</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; docker service ps demo</span><br><span class="line">ID                  NAME                IMAGE               NODE                DESIRED STATE       CURRENT STATE           ERROR               PORTS</span><br><span class="line">b6ws1m8o10vf        demo.1              busybox:latest      jaelyn              Running             Running 7 minutes ago</span><br><span class="line">&gt; docker ps</span><br><span class="line">CONTAINER ID        IMAGE                 COMMAND                  CREATED             STATUS              PORTS                                     NAMES</span><br><span class="line">26089d7a5f5d        busybox:latest        &quot;sh -c &apos;while true;d…&quot;   9 minutes ago       Up 9 minutes                                                  demo.1.b6ws1m8o10vfd6j8u2w4lakpa</span><br></pre></td></tr></table></figure>
<p>对于 service ls 中的 replicated ，表示可以水平扩展，和 scale 一样。</p>
<ul>
<li>docker service scale demo=3</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">docker service scale demo=3</span><br><span class="line">demo scaled to 3</span><br><span class="line">overall progress: 3 out of 3 tasks</span><br><span class="line">1/3: running   [==================================================&gt;]</span><br><span class="line">2/3: running   [==================================================&gt;]</span><br><span class="line">3/3: running   [==================================================&gt;]</span><br><span class="line">verify: Service converged</span><br></pre></td></tr></table></figure>
<p><img src="https://jaelyn-blog-txcos-1253450780.cos.ap-guangzhou.myqcloud.com/blog/2018-10-04-095140.png" alt=""></p>
<p>这时候再通过 service ls 去查看：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker service ls</span><br><span class="line">ID                  NAME                MODE                REPLICAS            IMAGE               PORTS</span><br><span class="line">bwsnflmg5hdd        demo                replicated          3/3                 busybox:latest</span><br></pre></td></tr></table></figure>
<p> 发现变成了 3/3 ，分母上的数表示有多少个 scale，分子上的数表示有多少个 ready 。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt; docker service ps demo</span><br><span class="line">ID                  NAME                IMAGE               NODE                DESIRED STATE       CURRENT STATE            ERROR               PORTS</span><br><span class="line">b6ws1m8o10vf        demo.1              busybox:latest      jaelyn              Running             Running 18 minutes ago                       </span><br><span class="line">k2wl7368ngxd        demo.2              busybox:latest      jaelyn              Running             Running 6 minutes ago                        </span><br><span class="line">bsqz3tb6mc9x        demo.3              busybox:latest      jaelyn              Running             Running 6 minutes ago</span><br></pre></td></tr></table></figure>
<p><img src="https://jaelyn-blog-txcos-1253450780.cos.ap-guangzhou.myqcloud.com/blog/2018-10-04-095836.png" alt=""></p>
<p>通过多容器部署的时候就可以发现，所建立的多个容器是部署在多个节点中的。（NODE）</p>
<p>可以在不同的节点去查看docker container ：</p>
<p><img src="https://jaelyn-blog-txcos-1253450780.cos.ap-guangzhou.myqcloud.com/blog/2018-10-04-102909.png" alt=""></p>
<p><img src="https://jaelyn-blog-txcos-1253450780.cos.ap-guangzhou.myqcloud.com/blog/2018-10-04-102948.png" alt=""></p>
<p><img src="https://jaelyn-blog-txcos-1253450780.cos.ap-guangzhou.myqcloud.com/blog/2018-10-04-103032.png" alt=""></p>
<p>尝试在一个节点中强制删除一个容器：</p>
<p><img src="https://jaelyn-blog-txcos-1253450780.cos.ap-guangzhou.myqcloud.com/blog/2018-10-04-103257.png" alt=""></p>
<p>短时间内会发现少了一个，接着就又会起来一个新的容器。</p>
<p>使用 docker service ps demo 查看详细信息：</p>
<p><img src="https://jaelyn-blog-txcos-1253450780.cos.ap-guangzhou.myqcloud.com/blog/2018-10-04-103522.png" alt=""></p>
<p>这里可以发现在一个节点失效之后，scale 会为了保证一定数量的节点的运行，在检测到有节点shutdown的时候，就会开启新的节点，这样可以保证 service 的稳定运行。</p>
<ul>
<li>docker service rm demo</li>
</ul>
<p>删除 service，并且同时也会把每个节点相对应的容器删除，不过这个过程需要一些时间。</p>
<h2 id="在-swarm-集群中创建-wordpress"><a href="#在-swarm-集群中创建-wordpress" class="headerlink" title="在 swarm 集群中创建 wordpress"></a>在 swarm 集群中创建 wordpress</h2><blockquote>
<p>练习的时候，playground 打不开，在一台机器上练习，所以所创建的 service 都在同一台机器上。</p>
</blockquote>
<p>在通过 swarm 集群创建节点的时候，因为所创建的节点是随机分配到不同的worker上的，也就是很有啃呢个不是在同一台机器上面的，对于一些需要相互访问的节点的时候，就需要先创建 overlay 网络。</p>
<p><code>docker network create -d overlay demo</code></p>
<p>接着创建 service</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker service create --name mysql --env MYSQL_ROOT_PASSWORD=root --env MYSQL_DATABASE=wordpress --network demo --mount type=volume,source=mysql-data,destination=/var/lib/mysql mysql</span><br></pre></td></tr></table></figure>
<p>其中，<code>--env</code> 表示环境配置， <code>--mount</code> 与 docker 当时的 volume 一样，表示数据持久化存储。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker service ls</span><br><span class="line">ID                  NAME                MODE                REPLICAS            IMAGE               PORTS</span><br><span class="line">zd9ttk1dtshg        mysql               replicated          1/1                 mysql:latest</span><br></pre></td></tr></table></figure>
<p>接着开启 wordpress 的service</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker service create --name wordpress -p 80:80 --env WORDPRESS_DB_PASSWORD=root --env WORDPRESS_DB_HOST=mysql --network demo wordpress</span><br></pre></td></tr></table></figure>
<p>通过 docker service ps wordpress 来查看</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; docker service ps wordpress</span><br><span class="line">ID                  NAME                IMAGE               NODE                DESIRED STATE       CURRENT STATE            ERROR               PORTS</span><br><span class="line">04ostrpat0o7        wordpress.1         wordpress:latest    jaelyn              Running             Running 57 seconds ago</span><br></pre></td></tr></table></figure>
<h2 id="集群服务间通信之RoutingMesh"><a href="#集群服务间通信之RoutingMesh" class="headerlink" title="集群服务间通信之RoutingMesh"></a>集群服务间通信之RoutingMesh</h2><p><img src="https://jaelyn-blog-txcos-1253450780.cos.ap-guangzhou.myqcloud.com/blog/2018-10-05-023904.png" alt=""></p>
<p>对于在不同机器上的节点，之所以能够相互访问，在底层上，是通过 DNS 服务实现的。</p>
<p>当我们创建一个新的 service 服务的时候，就会在 service 层面上，增加一条节点的 DNS 记录，就能知道所对应的节点的 IP 地址，就能访问对应的服务。并且所记录的 IP 地址其实不是真正的容器的 IP 地址，而是一个 虚拟 IP 地址（VIP），因为对于 service 来说，是可以通过 scale 来进行横向扩展的，并且在一个节点被删除或停止之后，也会重新创建一个新的节点，这个时候，所对应的实际容器的 IP 地址是在不断变换的，这个时候对外就会有一个 虚拟IP地址 。</p>
<p>接着做个测试</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker service create --name whoami -p 8000:8000 --network demo -d jwilder/whoami</span><br></pre></td></tr></table></figure>
<p>这里的 whoami 是一个简单 web， 就只会返回机器的hostname。</p>
<p>之后再开一个 busybox 来测试</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker service create --name client -d --network demo busybox sh -c &quot;while true; do sleep 3600; done&quot;</span><br></pre></td></tr></table></figure>
<p>查看启动情况：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&gt; docker service ls</span><br><span class="line">ID                  NAME                MODE                REPLICAS            IMAGE                   PORTS</span><br><span class="line">oa8pxzr72vep        client              replicated          1/1                 busybox:latest          </span><br><span class="line">aqj6bzzxusk5        whoami              replicated          1/1                 jwilder/whoami:latest   *:8000-&gt;8000/tcp</span><br><span class="line">&gt; docker service ps client</span><br><span class="line">ID                  NAME                IMAGE               NODE                DESIRED STATE       CURRENT STATE            ERROR               PORTS</span><br><span class="line">o6ov1q483d0e        client.1            busybox:latest      jaelyn              Running             Running 29 minutes ago  </span><br><span class="line">&gt; docker ps</span><br><span class="line">CONTAINER ID        IMAGE                   COMMAND                  CREATED             STATUS              PORTS               NAMES</span><br><span class="line">68bcd0b1d906        busybox:latest          &quot;sh -c &apos;while true; …&quot;   31 minutes ago      Up 31 minutes                           client.1.o6ov1q483d0ew0kfqay1yrxvy</span><br><span class="line">74c5ec05b169        jwilder/whoami:latest   &quot;/app/http&quot;              4 hours ago         Up 4 hours          8000/tcp            whoami.1.k4jo6l93hebrrf08ohqii6c6q</span><br></pre></td></tr></table></figure>
<p>尝试进去 busybox</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&gt; docker exec -it 68bcd0b1d906 sh</span><br><span class="line">/ #</span><br><span class="line">/ #</span><br><span class="line">/ # ping whoami</span><br><span class="line">PING whoami (10.0.0.13): 56 data bytes</span><br><span class="line">64 bytes from 10.0.0.13: seq=0 ttl=64 time=0.032 ms</span><br><span class="line">64 bytes from 10.0.0.13: seq=1 ttl=64 time=0.069 ms</span><br><span class="line">64 bytes from 10.0.0.13: seq=2 ttl=64 time=0.054 ms</span><br><span class="line">^C</span><br><span class="line">--- whoami ping statistics ---</span><br><span class="line">3 packets transmitted, 3 packets received, 0% packet loss</span><br><span class="line">round-trip min/avg/max = 0.032/0.051/0.069 ms</span><br></pre></td></tr></table></figure>
<p>这个时候可以发现，可以通过 10.0.0.13 的地址访问，接着尝试通过 scale 将 whoami 横向扩充。</p>
<p><code>docker service scale whoami=2</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker ps</span><br><span class="line">CONTAINER ID        IMAGE                   COMMAND                  CREATED             STATUS              PORTS               NAMES</span><br><span class="line">56fa29b13e03        jwilder/whoami:latest   &quot;/app/http&quot;              30 seconds ago      Up 29 seconds       8000/tcp            whoami.2.5k1feo0j3firaw2lq1rxrutrb</span><br><span class="line">68bcd0b1d906        busybox:latest          &quot;sh -c &apos;while true; …&quot;   About an hour ago   Up About an hour                        client.1.o6ov1q483d0ew0kfqay1yrxvy</span><br><span class="line">74c5ec05b169        jwilder/whoami:latest   &quot;/app/http&quot;              4 hours ago         Up 4 hours          8000/tcp            whoami.1.k4jo6l93hebrrf08ohqii6c6q</span><br></pre></td></tr></table></figure>
<p>已经开启了两个 whoami ，此时再去尝试 ping</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&gt; docker exec -it 68bcd0b1d906 sh</span><br><span class="line">/ #</span><br><span class="line">/ # ping whoami</span><br><span class="line">PING whoami (10.0.0.13): 56 data bytes</span><br><span class="line">64 bytes from 10.0.0.13: seq=0 ttl=64 time=0.032 ms</span><br><span class="line">64 bytes from 10.0.0.13: seq=1 ttl=64 time=0.072 ms</span><br><span class="line">64 bytes from 10.0.0.13: seq=2 ttl=64 time=0.069 ms</span><br><span class="line">^C</span><br><span class="line">--- whoami ping statistics ---</span><br><span class="line">3 packets transmitted, 3 packets received, 0% packet loss</span><br><span class="line">round-trip min/avg/max = 0.032/0.057/0.072 ms</span><br></pre></td></tr></table></figure>
<p>发现能 ping 通，并且所返回的地址依旧是 10.0.0.13 ，所以能证明，这个地址不是任何一个容器的地址，而是一个虚拟地址。</p>
<p>接着尝试去对应的 whoami 容器去查看 IP地址</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">docker exec 56fa29b13e03 ip a</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet 10.0.0.13/32 brd 10.0.0.13 scope global lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet 10.255.0.8/32 brd 10.255.0.8 scope global lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">141: eth0@if142: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1450 qdisc noqueue state UP</span><br><span class="line">    link/ether 02:42:0a:00:00:18 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 10.0.0.24/24 brd 10.0.0.255 scope global eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">143: eth1@if144: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue state UP</span><br><span class="line">    link/ether 02:42:ac:14:00:05 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.20.0.5/16 brd 172.20.255.255 scope global eth1</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">145: eth2@if146: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1450 qdisc noqueue state UP</span><br><span class="line">    link/ether 02:42:0a:ff:00:0a brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 10.255.0.10/16 brd 10.255.255.255 scope global eth2</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure>
<p>发现IP地址不是 10.0.0.13</p>
<blockquote>
<p>可以通过 <code>nslookup tasks.whoami</code> 命令去查看真正的容器所对应的 IP地址 。</p>
</blockquote>
<p>所以在我们创建 service 的时候，在swarm里面会分配一个虚拟的IP，在扩展的时候IP地址不变，并且在虚拟IP和实际IP之间有一层 Mac 关系，通过这关系找到真正的IP地址。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">/ # wget whoami:8000</span><br><span class="line">Connecting to whoami:8000 (10.0.0.13:8000)</span><br><span class="line">index.html           100% |********************************|    17  0:00:00 ETA</span><br><span class="line">/ # more index.html</span><br><span class="line">I&apos;m 56fa29b13e03</span><br><span class="line">/ # rm -rf index.html</span><br><span class="line">/ # wget whoami:8000</span><br><span class="line">Connecting to whoami:8000 (10.0.0.13:8000)</span><br><span class="line">index.html           100% |********************************|    17  0:00:00 ETA</span><br><span class="line">/ # more index.html</span><br><span class="line">I&apos;m 74c5ec05b169</span><br></pre></td></tr></table></figure>
<p>在busybox中尝试去多次访问whoami，发现对应的机器不同，当我们去访问10.0.0.13的时候，其实swarm里面有个负载均衡，在循环将我们的请求分配给不同的机器，并且做出响应。</p>
<p>routing mesh 的两种体现：</p>
<ul>
<li>Internal ：container 和 container 之间的访问通过 overlay 网络（通过VIP虚拟ip）</li>
<li>Ingress ：如果服务有绑定接口，则此服务可以通过任意swarm节点的相应接口访问</li>
</ul>
<p><img src="https://jaelyn-blog-txcos-1253450780.cos.ap-guangzhou.myqcloud.com/blog/2018-10-05-074405.png" alt=""></p>
<p><img src="https://jaelyn-blog-txcos-1253450780.cos.ap-guangzhou.myqcloud.com/blog/2018-10-05-074533.png" alt=""></p>
<h2 id="Ingress-Network"><a href="#Ingress-Network" class="headerlink" title="Ingress Network"></a>Ingress Network</h2><ul>
<li>外部访问的负载均衡</li>
<li>服务端口被暴露到各个swarm节点</li>
<li>内部通过IPVS进行负载均衡</li>
</ul>
<p>首先通过 <code>sudo iptables -nL -t nat</code> 命令去查看转发规则</p>
<p><img src="https://jaelyn-blog-txcos-1253450780.cos.ap-guangzhou.myqcloud.com/blog/2018-10-05-075749.png" alt=""></p>
<p>就会发现，当访问8000端口的时候，就会将请求转发到 172.20.0.2:8000 这个IP端口。</p>
<p>接着查看自己本机的IP地址的状态。</p>
<p><img src="https://jaelyn-blog-txcos-1253450780.cos.ap-guangzhou.myqcloud.com/blog/2018-10-05-080752.png" alt=""></p>
<p>发现其中的 docker_gwbridge 的IP地址（172.20.0.1/16）是和这个是属于同一个网段。</p>
<p>通过 <code>brctl show</code> 去查看网桥连接状态</p>
<p><img src="https://jaelyn-blog-txcos-1253450780.cos.ap-guangzhou.myqcloud.com/blog/2018-10-05-080933.png" alt=""></p>
<p>通过 <code>docker network inspect docker_gwbridge</code> 命令去查看该网桥的连接状态。</p>
<p><img src="https://jaelyn-blog-txcos-1253450780.cos.ap-guangzhou.myqcloud.com/blog/2018-10-05-081132.png" alt=""></p>
<p>发现IP地址所对应的 container 是 ingress-sbox</p>
<p>尝试进去该container</p>
<p>找到该网络配置在 /var/run/docker/netns 中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; sudo ls /var/run/docker/netns</span><br><span class="line">1-jq2xtmg7ah  1-yxt3cmxu3s  11463b8b5d62  80ea41b4be31  c64b02acbb1d  ingress_sbox</span><br></pre></td></tr></table></figure>
<p>之后通过 <code>sudo nsenter --net=/var/run/docker/netns/ingress_sbox</code> 进去该 network inspace</p>
<p>运行 <code>ip a</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">ip a</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">84: eth0@if85: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue state UP group default</span><br><span class="line">    link/ether 02:42:0a:ff:00:02 brd ff:ff:ff:ff:ff:ff link-netnsid 0</span><br><span class="line">    inet 10.255.0.2/16 brd 10.255.255.255 scope global eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">87: eth1@if88: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default</span><br><span class="line">    link/ether 02:42:ac:14:00:02 brd ff:ff:ff:ff:ff:ff link-netnsid 1</span><br><span class="line">    inet 172.20.0.2/16 brd 172.20.255.255 scope global eth1</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure>
<p>流程如下：</p>
<p><img src="https://jaelyn-blog-txcos-1253450780.cos.ap-guangzhou.myqcloud.com/blog/2018-10-05-081710.png" alt=""></p>
<p>安装一个工具 ： <code>sudo apt-get install ipvsadm</code></p>
<p>首先 使用 <code>iptables -nL -t mangle</code> 命令去查看网络映射情况</p>
<p><img src="https://jaelyn-blog-txcos-1253450780.cos.ap-guangzhou.myqcloud.com/blog/2018-10-05-082216.png" alt=""></p>
<p>接着使用 <code>ipvsadm -l</code></p>
<p><img src="https://jaelyn-blog-txcos-1253450780.cos.ap-guangzhou.myqcloud.com/blog/2018-10-05-082859.png" alt=""></p>
<p>两个所对应的地址就是实际容器的地址。</p>
<h2 id="DockerStack部署wordpress"><a href="#DockerStack部署wordpress" class="headerlink" title="DockerStack部署wordpress"></a>DockerStack部署wordpress</h2><p>尝试使用 docker compose 去部署 service</p>
<p>编写 docker-compose.yml 文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">version: &apos;3&apos;</span><br><span class="line"></span><br><span class="line">services:</span><br><span class="line"></span><br><span class="line">  web:</span><br><span class="line">    image: wordpress</span><br><span class="line">    ports:</span><br><span class="line">      - 8080:80</span><br><span class="line">    environment:</span><br><span class="line">      WORDPRESS_DB_HOST: mysql</span><br><span class="line">      WORDPRESS_DB_PASSWORD: root</span><br><span class="line">    networks:</span><br><span class="line">      - my-network</span><br><span class="line">    depends_on:</span><br><span class="line">      - mysql</span><br><span class="line">    deploy:</span><br><span class="line">      mode: replicated</span><br><span class="line">      replicas: 3</span><br><span class="line">      restart_policy:</span><br><span class="line">        condition: on-failure</span><br><span class="line">        delay: 5s</span><br><span class="line">        max_attempts: 3</span><br><span class="line">      update_config:</span><br><span class="line">        parallelism: 1</span><br><span class="line">        delay: 10s</span><br><span class="line"></span><br><span class="line">  mysql:</span><br><span class="line">    image: mysql</span><br><span class="line">    environment:</span><br><span class="line">      MYSQL_ROOT_PASSWORD: root</span><br><span class="line">      MYSQL_DATABASE: wordpress</span><br><span class="line">    volumes:</span><br><span class="line">      - mysql-data:/var/lib/mysql</span><br><span class="line">    networks:</span><br><span class="line">      - my-network</span><br><span class="line">    deploy:</span><br><span class="line">      mode: global</span><br><span class="line">      placement:</span><br><span class="line">        constraints:</span><br><span class="line">          - node.role == manager</span><br><span class="line"></span><br><span class="line">volumes:</span><br><span class="line">  mysql-data:</span><br><span class="line"></span><br><span class="line">networks:</span><br><span class="line">  my-network:</span><br><span class="line">    driver: overlay</span><br></pre></td></tr></table></figure>
<p>这个时候，需要使用 <code>docker stack</code> 命令去部署。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; docker stack deploy wordpress --compose-file=docker-compose.yml</span><br><span class="line">Creating network wordpress_my-network</span><br><span class="line">Creating service wordpress_web</span><br><span class="line">Creating service wordpress_mysql</span><br></pre></td></tr></table></figure>
<p>通过 <code>docker stack ls</code> 查看</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; docker stack ls</span><br><span class="line">NAME                SERVICES</span><br><span class="line">wordpress           2</span><br></pre></td></tr></table></figure>
<p>通过 <code>docker stack ps wordpress</code> 查看详细信息</p>
<p><img src="https://jaelyn-blog-txcos-1253450780.cos.ap-guangzhou.myqcloud.com/blog/2018-10-05-085321.png" alt=""></p>
<p>通过 <code>docker stack services wordpress</code> 查看 service 信息</p>
<p><img src="https://jaelyn-blog-txcos-1253450780.cos.ap-guangzhou.myqcloud.com/blog/2018-10-05-085546.png" alt=""></p>
<p>尝试访问，成功。</p>
<p>最后 通过 <code>docker stack rm wordpress</code> 删除</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; docker stack rm wordpress</span><br><span class="line">Removing service wordpress_mysql</span><br><span class="line">Removing service wordpress_web</span><br><span class="line">Removing network wordpress_my-network</span><br></pre></td></tr></table></figure>
<h2 id="DockerSecret"><a href="#DockerSecret" class="headerlink" title="DockerSecret"></a>DockerSecret</h2><p>如果我们将密码写在 docker-compose.yml 文件里面的话是不安全的，这时候就需要一个较为安全的密码管理工具。</p>
<p><img src="https://jaelyn-blog-txcos-1253450780.cos.ap-guangzhou.myqcloud.com/blog/2018-10-05-162442.png" alt=""></p>
<p>在同步数据的时候，有个 secret Management 的密码管理。</p>
<ul>
<li>存在 Swarm Manager 节点 Raft database 里</li>
<li>Secret 可以 assign 给一个 service ，这个 service 就能看到这个 secret</li>
<li>在 container 内部 secret 看起来像个文件，但是实际是在内存中的</li>
</ul>
<p>开始使用</p>
<ul>
<li>docker secret create</li>
</ul>
<p>创建一个密码，首先尝试使用文件的方式去创建</p>
<p>随意编写一个 文件 （vim pass），里面写上密码 （admin）</p>
<p>再使用命令去创建密码，<code>docker secret create my-pw password</code> ，最后，为了安全性，将原文件删除，<code>rm -rf pass</code> 。</p>
<p>第二种创建密码的方式是标准输入创建的。</p>
<p><code>echo &quot;admin&quot; | docker secret create my-pass -</code></p>
<ul>
<li>docker secret ls</li>
</ul>
<p>查看 docker 中所创建的 secret</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; docker secret ls</span><br><span class="line">ID                          NAME                DRIVER              CREATED             UPDATED</span><br><span class="line">q1z8ue5g9bgdkncq17mr6mbv3   my-pass                                 13 seconds ago      13 seconds ago</span><br><span class="line">4kzecbiuuxmpf6loi2oeluvnk   my-pw                                   11 minutes ago      11 minutes ago</span><br></pre></td></tr></table></figure>
<ul>
<li>docker secret rm</li>
</ul>
<p>删除</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt; docker secret rm my-pass</span><br><span class="line">my-pass</span><br><span class="line">&gt; docker secret ls</span><br><span class="line">ID                          NAME                DRIVER              CREATED             UPDATED</span><br><span class="line">4kzecbiuuxmpf6loi2oeluvnk   my-pw                                   14 minutes ago      14 minutes ago</span><br></pre></td></tr></table></figure>
<ul>
<li>使用</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker service create --name client --secret my-pw busybox sh -c &quot;while true; do sleep 3600; done&quot;</span><br></pre></td></tr></table></figure>
<p>通过 <code>--secret</code> 指明需要设置的 secret</p>
<p>在所对应的容器中去查看密码创建情况</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it a80 sh</span><br><span class="line">/ #</span><br><span class="line">/ #</span><br><span class="line">/ # cd /run/secrets/</span><br><span class="line">/run/secrets # ls</span><br><span class="line">my-pw</span><br><span class="line">/run/secrets # cat my-pw</span><br><span class="line">admin123</span><br><span class="line">/run/secrets #</span><br></pre></td></tr></table></figure>
<p>继续看在 mysql 中的使用</p>
<p><code>docker service create --name db --secret my-pw -e MYSQL_ROOT_PASSWORD_FILE=/run/secrets/my-pw mysql</code></p>
<p>通过 <code>MYSQL_ROOT_PASSWORD_FILE</code>  指定一个读取密码的文件，这个时候就可以通过 <code>--secre</code>  的方式，将密码写在对应的容器内。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it 6d6 sh</span><br><span class="line"># cd /run/secrets</span><br><span class="line"># ls</span><br><span class="line">my-pw</span><br><span class="line"># cat my-pw</span><br><span class="line">admin123</span><br><span class="line"># mysql -u root -p</span><br><span class="line">Enter password:</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 8</span><br><span class="line">Server version: 8.0.12 MySQL Community Server - GPL</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2018, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt; exit</span><br><span class="line">Bye</span><br><span class="line">#</span><br></pre></td></tr></table></figure>
<p>进入对应的容器，并且查看密码，最后使用该密码进入 mysql ，证明该命令成功。</p>
<h2 id="DockerSecret在Stack中的使用"><a href="#DockerSecret在Stack中的使用" class="headerlink" title="DockerSecret在Stack中的使用"></a>DockerSecret在Stack中的使用</h2><p>在使用的时候，建议先将密码创建好，之后再在 docker-compose.yml 文件中指定所使用的密码。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">version: &apos;3&apos;</span><br><span class="line"></span><br><span class="line">services:</span><br><span class="line"></span><br><span class="line">  web:</span><br><span class="line">    image: wordpress</span><br><span class="line">    ports:</span><br><span class="line">      - 8080:80</span><br><span class="line">    secrets:</span><br><span class="line">      - my-pw</span><br><span class="line">    environment:</span><br><span class="line">      WORDPRESS_DB_HOST: mysql</span><br><span class="line">      WORDPRESS_DB_PASSWORD_FILE: /run/secrets/my-pw</span><br><span class="line">    networks:</span><br><span class="line">      - my-network</span><br><span class="line">    depends_on:</span><br><span class="line">      - mysql</span><br><span class="line">    deploy:</span><br><span class="line">      mode: replicated</span><br><span class="line">      replicas: 3</span><br><span class="line">      restart_policy:</span><br><span class="line">        condition: on-failure</span><br><span class="line">        delay: 5s</span><br><span class="line">        max_attempts: 3</span><br><span class="line">      update_config:</span><br><span class="line">        parallelism: 1</span><br><span class="line">        delay: 10s</span><br><span class="line"></span><br><span class="line">  mysql:</span><br><span class="line">    image: mysql</span><br><span class="line">    secrets:</span><br><span class="line">      - my-pw</span><br><span class="line">    environment:</span><br><span class="line">      MYSQL_ROOT_PASSWORD_FILE: /run/secrets/my-pw</span><br><span class="line">      MYSQL_DATABASE: wordpress</span><br><span class="line">    volumes:</span><br><span class="line">      - mysql-data:/var/lib/mysql</span><br><span class="line">    networks:</span><br><span class="line">      - my-network</span><br><span class="line">    deploy:</span><br><span class="line">      mode: global</span><br><span class="line">      placement:</span><br><span class="line">        constraints:</span><br><span class="line">          - node.role == manager</span><br><span class="line"></span><br><span class="line">volumes:</span><br><span class="line">  mysql-data:</span><br><span class="line"></span><br><span class="line">networks:</span><br><span class="line">  my-network:</span><br><span class="line">    driver: overlay</span><br><span class="line"></span><br><span class="line"># secrets:</span><br><span class="line">#   my-pw:</span><br><span class="line">#    file: ./password</span><br></pre></td></tr></table></figure>
<p>不推荐定义 secrets 的方式，指明文件获取密码，不安全。</p>
<p>之后指定文件启动， <code>docker stack deploy wordpress -c=docker-compose.yml</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt; docker stack deploy wordpress -c=docker-compose.yml                                                           </span><br><span class="line">Creating secret wordpress_my-pw</span><br><span class="line">Creating service wordpress_web</span><br><span class="line">Creating service wordpress_mysql</span><br><span class="line">&gt; docker stack ls</span><br><span class="line">NAME                SERVICES</span><br><span class="line">wordpress           2</span><br></pre></td></tr></table></figure>

      
    </div>
    
    
    

    

    

    
      <div>
        <ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者：</strong>
    Jaelyn
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="http://jaelyn.coding.me/2018/10/06/docker-learning02/" title="Docker 学习 02">http://jaelyn.coding.me/2018/10/06/docker-learning02/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>
    本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> 许可协议。转载请注明出处！
  </li>
</ul>

      </div>
    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Docker/" rel="tag"><i class="fa fa-tag"></i> Docker</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/09/08/python-super-learning-05/" rel="next" title="Python 高级编程和异步IO开发 05">
                <i class="fa fa-chevron-left"></i> Python 高级编程和异步IO开发 05
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.png"
                alt="Jaelyn" />
            
              <p class="site-author-name" itemprop="name">Jaelyn</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">35</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">12</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">20</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          <div class="links-of-author motion-element">
            
              
                <span class="links-of-author-item">
                  <a href="https://github.com/Jaelyn-Lim" target="_blank" title="GitHub">
                    
                      <i class="fa fa-fw fa-globe"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  <a href="https://weibo.com/u/2660619527" target="_blank" title="微博">
                    
                      <i class="fa fa-fw fa-globe"></i>微博</a>
                </span>
              
            
          </div>

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Docker-网络"><span class="nav-number">1.</span> <span class="nav-text">Docker 网络</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#网络命名空间"><span class="nav-number">1.1.</span> <span class="nav-text">网络命名空间</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Bridge0"><span class="nav-number">1.2.</span> <span class="nav-text">Bridge0</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#link"><span class="nav-number">1.3.</span> <span class="nav-text">link</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#端口映射"><span class="nav-number">1.4.</span> <span class="nav-text">端口映射</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Host-和-none"><span class="nav-number">1.5.</span> <span class="nav-text">Host 和 none</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#多容器复杂应用"><span class="nav-number">1.6.</span> <span class="nav-text">多容器复杂应用</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Docker-持久化存储和数据共享"><span class="nav-number">2.</span> <span class="nav-text">Docker 持久化存储和数据共享</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Data-Volume"><span class="nav-number">2.1.</span> <span class="nav-text">Data Volume</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Bild-Mouting"><span class="nav-number">2.2.</span> <span class="nav-text">Bild Mouting</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Docker-Compose"><span class="nav-number">3.</span> <span class="nav-text">Docker Compose</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#尝试去创建-wordpress-来使用"><span class="nav-number">3.1.</span> <span class="nav-text">尝试去创建 wordpress 来使用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#docker-compose-是什么"><span class="nav-number">3.2.</span> <span class="nav-text">docker compose 是什么</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#多容器部署app"><span class="nav-number">3.2.1.</span> <span class="nav-text">多容器部署app</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#简介"><span class="nav-number">3.2.2.</span> <span class="nav-text">简介</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#默认的名称"><span class="nav-number">3.2.3.</span> <span class="nav-text">默认的名称</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#三个概念"><span class="nav-number">3.2.4.</span> <span class="nav-text">三个概念</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Services"><span class="nav-number">3.2.4.1.</span> <span class="nav-text">Services</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#例子"><span class="nav-number">3.2.5.</span> <span class="nav-text">例子</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#docker-compose-安装和基本使用"><span class="nav-number">3.3.</span> <span class="nav-text">docker-compose 安装和基本使用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#安装下载-docker-compose"><span class="nav-number">3.3.1.</span> <span class="nav-text">安装下载 docker-compose</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用"><span class="nav-number">3.3.2.</span> <span class="nav-text">使用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#对于一些需要build的docker-compose"><span class="nav-number">3.3.3.</span> <span class="nav-text">对于一些需要build的docker-compose</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#水平扩展扩展和负载均衡"><span class="nav-number">3.4.</span> <span class="nav-text">水平扩展扩展和负载均衡</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Swarm-mode"><span class="nav-number">4.</span> <span class="nav-text">Swarm mode</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#搭建三个节点的-swarm-集群"><span class="nav-number">4.1.</span> <span class="nav-text">搭建三个节点的 swarm 集群</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Service-的创建维护和水平扩展"><span class="nav-number">4.2.</span> <span class="nav-text">Service 的创建维护和水平扩展</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#在-swarm-集群中创建-wordpress"><span class="nav-number">4.3.</span> <span class="nav-text">在 swarm 集群中创建 wordpress</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#集群服务间通信之RoutingMesh"><span class="nav-number">4.4.</span> <span class="nav-text">集群服务间通信之RoutingMesh</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Ingress-Network"><span class="nav-number">4.5.</span> <span class="nav-text">Ingress Network</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#DockerStack部署wordpress"><span class="nav-number">4.6.</span> <span class="nav-text">DockerStack部署wordpress</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#DockerSecret"><span class="nav-number">4.7.</span> <span class="nav-text">DockerSecret</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#DockerSecret在Stack中的使用"><span class="nav-number">4.8.</span> <span class="nav-text">DockerSecret在Stack中的使用</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2017 &mdash; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Jaelyn</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">Site words total count&#58;</span>
    
    <span title="Site words total count">123.1k</span>
  
</div>









        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i> 访问人数
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i> 访问总量
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      
    </span>
  
</div>



<script>
  	var _mtac = {};
  	(function() {
  		var mta = document.createElement("script");
  		mta.src = "https://pingjs.qq.com/h5/stats.js?v2.0.4";
  		mta.setAttribute("name", "MTAH5");
  		mta.setAttribute("sid", "500569228");

  		var s = document.getElementsByTagName("script")[0];
  		s.parentNode.insertBefore(mta, s);
  	})();
</script>



  <script type="text/javascript">
    (function() {
      var hm = document.createElement("script");
      hm.src = "//tajs.qq.com/stats?sId=64866827";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.3"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.3"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.3"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('-1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  
  

  

  

  


  <script>
    var _mtac = {};
    (function() {
      var mta = document.createElement("script");
      mta.src = "http://pingjs.qq.com/h5/stats.js?v2.0.2";
      mta.setAttribute("name", "MTAH5");
      mta.setAttribute("sid", "500569228");
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(mta, s);
    })();
  </script>

  <script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>

<script src="/live2dw/lib/L2Dwidget.min.js?0c58a1486de42ac6cc1c59c7d98ae887"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/z16.model.json"},"display":{"position":"right","width":100,"height":200},"mobile":{"show":false},"log":false});</script></body>
</html>
